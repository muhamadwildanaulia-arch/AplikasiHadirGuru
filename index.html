<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Website Hadir Guru</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .card-smooth {
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); /* shadow-lg */
        }
        .text-truncate {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* Z-index tinggi untuk modal dan toast */
        .z-60 { z-index: 60; }
        .z-70 { z-index: 70; }
        .z-80 { z-index: 80; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <div id="toast-container" class="fixed top-5 right-5 space-y-2 z-80"></div>

    <aside id="sidebar" class="fixed top-0 left-0 h-full w-64 bg-indigo-700 text-white p-4 hidden md:block">
        <h1 class="text-2xl font-bold mb-6 border-b border-indigo-500 pb-2">Website Hadir</h1>
        <nav>
            <ul class="space-y-2">
                <li><button data-page="kehadiran" class="nav-item w-full text-left px-3 py-2 rounded-md bg-indigo-600 hover:bg-indigo-500 font-medium">ğŸ  Input Kehadiran</button></li>
                <li><button data-page="dashboard" class="nav-item w-full text-left px-3 py-2 rounded-md text-white hover:bg-indigo-500">ğŸ“Š Dashboard Hari Ini</button></li>
                <li><button data-page="guru" class="nav-item w-full text-left px-3 py-2 rounded-md text-white hover:bg-indigo-500">ğŸ§‘â€ğŸ« Data Guru</button></li>
                <li><button data-page="laporan" class="nav-item w-full text-left px-3 py-2 rounded-md text-white hover:bg-indigo-500">ğŸ“œ Laporan Bulanan</button></li>
            </ul>
        </nav>
        
        <div class="mt-8 pt-4 border-t border-indigo-500 px-1">
            <button id="btn-open-login" class="w-full text-left px-3 py-2 rounded-md bg-red-700 text-white hover:bg-red-800 font-medium">ğŸ”‘ Login Admin</button>
            <div id="admin-actions" class="mt-4 space-y-2">
                <button id="btn-open-add-guru" class="w-full text-left px-3 py-2 rounded-md bg-green-600 text-white hover:bg-green-700 font-medium hidden">â• Tambah Guru</button>
                <button id="btn-reset-sample" class="w-full text-left px-3 py-2 rounded-md bg-amber-600 text-white hover:bg-amber-700 font-medium hidden">ğŸ”„ Reset Data</button>
            </div>
        </div>
    </aside>

    <div class="md:ml-64 p-4">

        <header class="md:hidden bg-white card-smooth p-3 mb-4 flex justify-between items-center">
            <h1 class="text-xl font-bold text-indigo-700">W Hadir</h1>
            <nav class="flex space-x-2">
                <button data-page="kehadiran" class="nav-item px-3 py-2 rounded-full text-sm bg-indigo-100 text-indigo-700 font-medium">ğŸ </button>
                <button data-page="dashboard" class="nav-item px-3 py-2 rounded-full text-sm bg-gray-100 text-gray-700">ğŸ“Š</button>
                <button data-page="guru" class="nav-item px-3 py-2 rounded-full text-sm bg-gray-100 text-gray-700">ğŸ§‘â€ğŸ«</button>
                <button data-page="laporan" class="nav-item px-3 py-2 rounded-full text-sm bg-gray-100 text-gray-700">ğŸ“œ</button>
            </nav>
        </header>

        <main>
            
            <section id="page-kehadiran" class="card-smooth p-4">
                <h2 class="text-xl font-semibold mb-4 text-indigo-700">Input Kehadiran Guru Hari Ini</h2>
                <div class="bg-indigo-50 p-4 rounded-lg mb-4">
                    <p class="text-sm font-medium text-indigo-700" id="current-date-display"></p>
                    <p class="text-sm text-indigo-700" id="current-location-display">Lokasi: Mencari...</p>
                </div>

                <form id="attendance-form" class="space-y-4">
                    <div>
                        <label for="guru-select" class="block text-sm font-medium text-gray-700">Nama Guru:</label>
                        <select id="guru-select" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 bg-white"></select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Status Kehadiran:</label>
                        <div class="mt-2 space-y-2">
                            <label class="inline-flex items-center">
                                <input type="radio" name="status" value="Hadir" checked class="form-radio text-green-600 h-4 w-4">
                                <span class="ml-2">Hadir (Masuk Kerja)</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="status" value="Izin" class="form-radio text-amber-600 h-4 w-4">
                                <span class="ml-2">Izin</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="status" value="Sakit" class="form-radio text-red-600 h-4 w-4">
                                <span class="ml-2">Sakit</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="status" value="Dinas Luar" class="form-radio text-blue-600 h-4 w-4">
                                <span class="ml-2">Dinas Luar</span>
                            </label>
                        </div>
                    </div>
                    
                    <button type="submit" id="submit-button" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 font-semibold transition duration-150">Kirim Kehadiran</button>
                </form>
            </section>

            <section id="page-dashboard" class="hidden mt-6 card-smooth p-4">
                <h2 class="text-xl font-semibold mb-4">ğŸ“Š Dashboard Kehadiran Hari Ini</h2>
                
                <div id="dashboard-summary" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    </div>

                <h3 class="text-lg font-semibold mb-3">Daftar Kehadiran</h3>
                <div class="overflow-auto">
                    <table class="min-w-full divide-y divide-gray-200 text-sm" aria-label="Tabel Kehadiran Hari Ini">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Guru</th>
                                <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Jam</th>
                                <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lokasi</th>
                            </tr>
                        </thead>
                        <tbody id="attendance-list-body" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="4" class="text-center p-4 text-gray-500">Memuat data kehadiran...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="page-guru" class="hidden mt-6 card-smooth p-4">
                <h2 class="text-xl font-semibold mb-4">ğŸ§‘â€ğŸ« Data Guru</h2>
                <div id="guru-table-container" class="overflow-auto">
                    <table class="min-w-full divide-y divide-gray-200 text-sm" aria-label="Tabel Data Guru">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NIP</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jabatan</th>
                                <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th id="guru-action-header" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider hidden">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="guru-table-body" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="5" class="text-center p-4 text-gray-500">Memuat data guru...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="page-laporan" class="hidden mt-6 card-smooth p-4">
              <h2 class="text-xl font-semibold mb-4">ğŸ“œ Laporan Bulanan</h2>
              <div class="flex flex-wrap items-center gap-3 mb-4">
                <label for="reportMonth" class="text-sm font-medium">Bulan:</label>
                <select id="reportMonth" class="border rounded p-2 text-sm"></select>
                <label for="reportYear" class="text-sm font-medium">Tahun:</label>
                <select id="reportYear" class="border rounded p-2 text-sm"></select>
                <button id="generateReportBtn" class="px-3 py-2 rounded bg-sky-600 text-white text-sm hover:bg-sky-700">Tampilkan Laporan</button>
              </div>
              
              <div id="report-summary" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                </div>

              <h3 class="text-lg font-semibold mb-3">Rekapitulasi Kehadiran</h3>
              <div class="overflow-auto">
                <table class="min-w-full text-sm border border-gray-200" aria-label="Tabel Laporan Bulanan Guru">
                  <thead class="bg-indigo-50 text-indigo-700 font-semibold sticky top-0">
                    <tr>
                      <th class="p-2 text-left border">Nama Guru</th>
                      <th class="p-2 text-center border">Hadir</th>
                      <th class="p-2 text-center border">Izin</th>
                      <th class="p-2 text-center border">Sakit</th>
                      <th class="p-2 text-center border">Dinas Luar</th>
                      <th class="p-2 text-center border">Total Absen</th>
                    </tr>
                  </thead>
                  <tbody id="reportTableBody">
                    <tr><td colspan="6" class="text-center p-6 text-slate-500">Silakan pilih bulan dan tahun, lalu klik Tampilkan Laporan.</td></tr>
                  </tbody>
                </table>
              </div>
            </section>

        </main>
    </div>

    <div id="login-modal" class="fixed inset-0 z-60 hidden items-center justify-center bg-black/40">
        <div class="bg-white rounded-xl shadow-lg p-6 w-96 max-w-sm">
            <h3 class="text-xl font-semibold mb-4 text-indigo-700">ğŸ”‘ Login Admin</h3>
            <div class="space-y-4">
                <input id="login-email" type="email" placeholder="Email Admin" class="w-full border rounded p-3 focus:ring-indigo-500 focus:border-indigo-500" />
                <input id="login-password" type="password" placeholder="Password" class="w-full border rounded p-3 focus:ring-indigo-500 focus:border-indigo-500" />
                <div class="flex justify-end gap-3 pt-2">
                    <button id="login-cancel" type="button" class="px-4 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-700">Batal</button>
                    <button id="login-submit" type="button" class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 font-medium">Login</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="guru-modal" class="fixed inset-0 z-60 hidden items-center justify-center bg-black/40">
        <div class="bg-white rounded-xl shadow-lg p-6 w-96 max-w-sm">
            <h3 class="text-xl font-semibold mb-4 text-indigo-700" id="guru-modal-title">Tambah Guru</h3>
            <form id="guru-form" class="space-y-4">
                <input type="hidden" id="guru-id" />
                <div>
                    <label for="guru-nip" class="block text-sm font-medium text-gray-700">NIP:</label>
                    <input type="text" id="guru-nip" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" />
                </div>
                <div>
                    <label for="guru-nama" class="block text-sm font-medium text-gray-700">Nama Lengkap:</label>
                    <input type="text" id="guru-nama" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" />
                </div>
                <div>
                    <label for="guru-jabatan" class="block text-sm font-medium text-gray-700">Jabatan:</label>
                    <input type="text" id="guru-jabatan" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" />
                </div>
                <div class="flex justify-end gap-3 pt-2">
                    <button type="button" id="guru-cancel" class="px-4 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-700">Batal</button>
                    <button type="submit" id="guru-submit" class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 font-medium">Simpan</button>
                </div>
            </form>
        </div>
    </div>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <script src="app.firebase.js"></script>

    <script>
        // Utility Functions
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        let whGuruList = [];
        let whAttList = [];
        let whIsAdmin = false;

        // --- TOAST NOTIFICATIONS ---
        function toast(message, type = 'info', duration = 3000) {
            const container = $('#toast-container');
            const colorMap = {
                'info': 'bg-blue-500',
                'ok': 'bg-green-500',
                'err': 'bg-red-500'
            };
            const bgColor = colorMap[type] || colorMap['info'];

            const div = document.createElement('div');
            div.className = `p-3 rounded-lg text-white ${bgColor} shadow-xl max-w-xs transition-all duration-300 ease-out transform translate-x-0 opacity-100 z-70`;
            div.textContent = message;

            container.appendChild(div);

            setTimeout(() => {
                div.classList.replace('opacity-100', 'opacity-0');
                div.classList.replace('translate-x-0', 'translate-x-full');
                div.addEventListener('transitionend', () => div.remove());
            }, duration);
        }

        // --- DATA HANDLERS (Local Fallback) ---
        function loadGuruList() {
            if (window.whUseFirebase) return whGuruList;
            try {
                const data = localStorage.getItem('wh_guru_list_v1');
                return data ? JSON.parse(data) : [];
            } catch { return []; }
        }

        function loadAtt() {
            if (window.whUseFirebase) return whAttList;
            try {
                const data = localStorage.getItem('wh_att_list_v1');
                return data ? JSON.parse(data) : [];
            } catch { return []; }
        }

        function saveAtt(data) {
            if (window.whUseFirebase && window.addAttendanceFirebase) {
                return window.addAttendanceFirebase(data);
            }
            // Local fallback
            const currentAtt = loadAtt();
            currentAtt.push(data);
            localStorage.setItem('wh_att_list_v1', JSON.stringify(currentAtt));
            return data;
        }

        // --- NAVIGATION & UI STATE ---
        function showPage(name) {
            const pages = {
                'kehadiran': $('#page-kehadiran'),
                'dashboard': $('#page-dashboard'),
                'guru': $('#page-guru'),
                'laporan': $('#page-laporan') // Tambah Laporan
            };

            Object.keys(pages).forEach(key => {
                if (pages[key]) {
                    pages[key].classList.toggle('hidden', key !== name);
                }
            });

            // Update Nav Item styles
            $$('.nav-item').forEach(btn => {
                const isActive = btn.getAttribute('data-page') === name;
                btn.classList.toggle('bg-indigo-600', isActive);
                btn.classList.toggle('bg-white/10', isActive && btn.closest('aside')); // Sidebar active style
                btn.classList.toggle('text-white', isActive && btn.closest('aside')); // Sidebar active style
                btn.classList.toggle('text-indigo-700', isActive && btn.closest('header')); // Mobile active style
                btn.classList.toggle('bg-indigo-100', isActive && btn.closest('header')); // Mobile active style
            });
            
            // Re-render data when changing pages
            if (name === 'dashboard') renderDashboard();
            if (name === 'guru') renderGuruTable();
            if (name === 'laporan') generateReport(); // Muat laporan saat halaman dibuka
        }

        // Event listener untuk Navigasi
        $$('.nav-item').forEach(btn => {
            btn.addEventListener('click', (e) => {
                showPage(e.currentTarget.getAttribute('data-page'));
            });
        });

        // --- Laporan Bulanan Logic (BARU) ---

        const reportMonthSel = $('#reportMonth');
        const reportYearSel = $('#reportYear');
        const generateReportBtn = $('#generateReportBtn');
        const reportTableBody = $('#reportTableBody');
        const reportSummary = $('#report-summary');

        // Helper: Populate Bulan dan Tahun
        function populateReportSelectors(){
            const now = new Date();
            const currentYear = now.getFullYear();
            const months = ['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];
            
            reportMonthSel.innerHTML = months.map((m, i) => `<option value="${(i+1).toString().padStart(2,'0')}">${m}</option>`).join('');
            
            // 5 tahun ke belakang dan 1 tahun ke depan
            const years = [];
            for (let y = currentYear - 5; y <= currentYear + 1; y++) {
                years.push(y);
            }
            reportYearSel.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');
            
            // Set default ke bulan dan tahun ini
            reportMonthSel.value = (now.getMonth() + 1).toString().padStart(2,'0');
            reportYearSel.value = currentYear;
        }
        
        // Helper: Generate Laporan
        function generateReport(){
            const selectedMonth = reportMonthSel.value;
            const selectedYear = reportYearSel.value;
            const prefixDate = `${selectedYear}-${selectedMonth}`;
            
            const allAtt = loadAtt(); 
            const gurus = loadGuruList();
            
            // 1. Filter data untuk bulan/tahun terpilih
            const monthlyAtt = allAtt.filter(att => att.tanggal && att.tanggal.startsWith(prefixDate));
            
            // 2. Agregasi data per Guru
            const reportData = {};
            gurus.forEach(g => {
                reportData[g.id] = { 
                    nama: g.nama,
                    Hadir: 0, Izin: 0, Sakit: 0, 'Dinas Luar': 0, 
                    TotalAbsen: 0 // Izin, Sakit, Dinas Luar
                };
            });
            
            monthlyAtt.forEach(att => {
                const status = att.status;
                const guruId = att.idGuru;
                if (reportData[guruId]) {
                    if (reportData[guruId][status] !== undefined) {
                         reportData[guruId][status]++;
                    }
                    if (['Izin', 'Sakit', 'Dinas Luar'].includes(status)) {
                        reportData[guruId].TotalAbsen++;
                    }
                }
            });
            
            // 3. Render Tabel
            reportTableBody.innerHTML = '';
            const guruIds = Object.keys(reportData).sort((a,b) => reportData[a].nama.localeCompare(reportData[b].nama));
            let totalHadirAll = 0, totalIzinAll = 0, totalSakitAll = 0, totalDinasAll = 0;

            if (guruIds.length > 0) {
                guruIds.forEach(id => {
                    const data = reportData[id];
                    totalHadirAll += data.Hadir;
                    totalIzinAll += data.Izin;
                    totalSakitAll += data.Sakit;
                    totalDinasAll += data['Dinas Luar'];

                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-slate-50';
                    tr.innerHTML = `
                        <td class="p-2 border border-gray-200">${data.nama}</td>
                        <td class="p-2 border border-gray-200 text-center font-bold text-green-600">${data.Hadir}</td>
                        <td class="p-2 border border-gray-200 text-center text-amber-600">${data.Izin}</td>
                        <td class="p-2 border border-gray-200 text-center text-rose-600">${data.Sakit}</td>
                        <td class="p-2 border border-gray-200 text-center text-sky-600">${data['Dinas Luar']}</td>
                        <td class="p-2 border border-gray-200 text-center font-bold text-lg">${data.TotalAbsen}</td>
                    `;
                    reportTableBody.appendChild(tr);
                });
            } else {
                 reportTableBody.innerHTML = '<tr><td colspan="6" class="text-center p-6 text-slate-500">Tidak ada data guru atau kehadiran yang cocok di bulan ini.</td></tr>';
            }
            
            // 4. Render Summary Cards
            const selectedMonthName = reportMonthSel.options[reportMonthSel.selectedIndex].text;
            reportSummary.innerHTML = `
                <div class="card-smooth p-5 bg-green-50">
                    <div class="text-sm text-slate-500">Total Kehadiran (${selectedMonthName})</div>
                    <div class="text-3xl font-bold text-green-600 mt-2">${totalHadirAll}</div>
                </div>
                <div class="card-smooth p-5 bg-amber-50">
                    <div class="text-sm text-slate-500">Total Absen (Izin/Sakit/DL)</div>
                    <div class="text-3xl font-bold text-amber-600 mt-2">${totalIzinAll + totalSakitAll + totalDinasAll}</div>
                </div>
                <div class="card-smooth p-5 bg-indigo-50">
                    <div class="text-sm text-slate-500">Total Guru Aktif</div>
                    <div class="text-3xl font-bold text-indigo-600 mt-2">${gurus.length}</div>
                </div>
            `;
            
            toast(`Laporan Bulanan berhasil dimuat.`, 'info', 1500);
        }

        // Event Listener Laporan
        generateReportBtn.addEventListener('click', generateReport);
        // Panggil saat awal load
        populateReportSelectors();


        // --- DASHBOARD LOGIC (Simplified) ---
        function renderDashboard() {
            const today = new Date().toISOString().slice(0, 10);
            const todayAtt = loadAtt().filter(att => att.tanggal === today).reverse();
            const guruList = loadGuruList();
            
            const summary = { Hadir: 0, Izin: 0, Sakit: 0, 'Dinas Luar': 0, Total: guruList.length };
            const todayAttIds = new Set();

            todayAtt.forEach(att => {
                // Hanya hitungan status yang pertama kali diinput hari ini
                if (!todayAttIds.has(att.idGuru)) {
                    summary[att.status] = (summary[att.status] || 0) + 1;
                    todayAttIds.add(att.idGuru);
                }
            });
            
            // Hitung Belum Hadir
            summary.BelumHadir = summary.Total - todayAttIds.size;
            
            // Render Summary
            $('#dashboard-summary').innerHTML = `
                <div class="card-smooth p-3 bg-green-50"><p class="text-xs text-slate-500">Hadir</p><p class="text-2xl font-bold text-green-600">${summary.Hadir}</p></div>
                <div class="card-smooth p-3 bg-amber-50"><p class="text-xs text-slate-500">Izin/Sakit/DL</p><p class="text-2xl font-bold text-amber-600">${summary.Izin + summary.Sakit + summary['Dinas Luar']}</p></div>
                <div class="card-smooth p-3 bg-red-50"><p class="text-xs text-slate-500">Belum Hadir</p><p class="text-2xl font-bold text-red-600">${summary.BelumHadir}</p></div>
                <div class="card-smooth p-3 bg-indigo-50"><p class="text-xs text-slate-500">Total Guru</p><p class="text-2xl font-bold text-indigo-600">${summary.Total}</p></div>
            `;

            // Render List
            const listBody = $('#attendance-list-body');
            listBody.innerHTML = todayAtt.map(att => `
                <tr class="hover:bg-gray-50">
                    <td class="px-3 py-2 whitespace-nowrap">${att.namaGuru}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-center">${att.jam}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-center">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                            ${att.status === 'Hadir' ? 'bg-green-100 text-green-800' : 
                              att.status === 'Izin' ? 'bg-amber-100 text-amber-800' : 
                              att.status === 'Sakit' ? 'bg-red-100 text-red-800' : 
                              'bg-blue-100 text-blue-800'}">
                            ${att.status}
                        </span>
                    </td>
                    <td class="px-3 py-2 text-truncate max-w-xs" title="${att.tempat || 'N/A'}">${att.tempat || 'N/A'}</td>
                </tr>
            `).join('');

            if (todayAtt.length === 0) {
                 listBody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-gray-500">Belum ada kehadiran hari ini.</td></tr>';
            }
        }

        // --- GURU PAGE LOGIC (Simplified) ---
        function renderGuruSelect() {
            const select = $('#guru-select');
            const gurus = loadGuruList().filter(g => g.status === 'Aktif').sort((a, b) => a.nama.localeCompare(b.nama));
            select.innerHTML = '<option value="">-- Pilih Guru --</option>' + gurus.map(g => 
                `<option value="${g.id}" data-nama="${g.nama}">${g.nama} (${g.jabatan})</option>`
            ).join('');
        }

        function renderGuruTable() {
            const body = $('#guru-table-body');
            const guruList = loadGuruList().sort((a, b) => a.nama.localeCompare(b.nama));
            const isAdmin = whIsAdmin;

            $('#guru-action-header').classList.toggle('hidden', !isAdmin);
            
            body.innerHTML = guruList.map(guru => `
                <tr class="hover:bg-gray-50" data-id="${guru.id}">
                    <td class="px-3 py-2 whitespace-nowrap font-medium text-gray-900">${guru.nama}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-gray-500">${guru.nip || '-'}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-gray-500">${guru.jabatan || '-'}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-center">
                         <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                            ${guru.status}
                        </span>
                    </td>
                    <td class="px-3 py-2 whitespace-nowrap text-right text-sm font-medium ${isAdmin ? '' : 'hidden'}">
                        <button onclick="openGuruModal('${guru.id}')" class="text-indigo-600 hover:text-indigo-900 mr-2">Edit</button>
                        <button onclick="deleteGuru('${guru.id}', '${guru.nama}')" class="text-red-600 hover:text-red-900">Hapus</button>
                    </td>
                </tr>
            `).join('');

            if (guruList.length === 0) {
                 body.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-gray-500">Belum ada data guru.</td></tr>';
            }
        }
        
        // --- GURU MODAL LOGIC (Simplified) ---
        const guruModal = $('#guru-modal');
        const guruForm = $('#guru-form');
        const guruIdInput = $('#guru-id');
        const guruNamaInput = $('#guru-nama');
        const guruNipInput = $('#guru-nip');
        const guruJabatanInput = $('#guru-jabatan');
        const guruModalTitle = $('#guru-modal-title');
        const btnOpenAddGuru = $('#btn-open-add-guru');

        btnOpenAddGuru.addEventListener('click', () => openGuruModal(''));
        $('#guru-cancel').addEventListener('click', () => guruModal.classList.add('hidden'));

        function openGuruModal(id) {
            if (!whIsAdmin) { toast('Anda tidak memiliki izin Admin.', 'err'); return; }
            
            guruForm.reset();
            guruIdInput.value = '';
            
            if (id) {
                const guru = loadGuruList().find(g => g.id === id);
                if (guru) {
                    guruModalTitle.textContent = 'Edit Guru';
                    guruIdInput.value = guru.id;
                    guruNamaInput.value = guru.nama;
                    guruNipInput.value = guru.nip;
                    guruJabatanInput.value = guru.jabatan;
                }
            } else {
                guruModalTitle.textContent = 'Tambah Guru';
            }
            guruModal.classList.remove('hidden');
        }

        guruForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = guruIdInput.value;
            const data = {
                nama: guruNamaInput.value.trim(),
                nip: guruNipInput.value.trim(),
                jabatan: guruJabatanInput.value.trim()
            };

            try {
                if (id && window.updateGuruFirebase) {
                    await window.updateGuruFirebase(id, data);
                    toast('Data guru berhasil diubah!', 'ok');
                } else if (window.addGuruFirebase) {
                    await window.addGuruFirebase(data);
                    toast('Data guru berhasil ditambahkan!', 'ok');
                } else {
                    toast('Operasi tidak didukung.', 'err');
                }
            } catch (error) {
                toast(`Gagal menyimpan: ${error.message}`, 'err');
            }
            guruModal.classList.add('hidden');
        });

        async function deleteGuru(id, nama) {
             if (!whIsAdmin) { toast('Anda tidak memiliki izin Admin.', 'err'); return; }
             if (!confirm(`Yakin ingin menghapus guru: ${nama}?`)) return;

             try {
                if (window.deleteGuruFirebase) {
                    await window.deleteGuruFirebase(id);
                    toast('Guru berhasil dihapus!', 'ok');
                }
             } catch (error) {
                toast(`Gagal menghapus: ${error.message}`, 'err');
             }
        }
        window.deleteGuru = deleteGuru; // Expose to global scope for HTML onclick

        // --- ATTENDANCE SUBMISSION ---
        $('#attendance-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const selectedOption = $('#guru-select').options[$('#guru-select').selectedIndex];
            const idGuru = selectedOption.value;
            const namaGuru = selectedOption.getAttribute('data-nama');
            const status = $('input[name="status"]:checked').value;
            const lokasiText = $('#current-location-display').textContent.replace('Lokasi: ', '');
            
            if (!idGuru) {
                return toast('Pilih nama guru terlebih dahulu', 'err');
            }

            const now = new Date();
            const attendanceData = {
                idGuru,
                namaGuru,
                status,
                tanggal: now.toISOString().slice(0, 10),
                jam: now.toLocaleTimeString("id-ID"),
                tempat: lokasiText,
                lat: window.currentCoords ? window.currentCoords.lat : null,
                lon: window.currentCoords ? window.currentCoords.lon : null,
            };

            try {
                await saveAtt(attendanceData);
                toast(`Kehadiran ${status} untuk ${namaGuru} berhasil disimpan!`, 'ok');
                $('#attendance-form').reset();
                renderDashboard(); // Update dashboard setelah submit
            } catch (error) {
                toast(`Gagal menyimpan kehadiran: ${error.message}`, 'err');
            }
        });

        // --- LOGIN ADMIN LOGIC (BARU) ---
        const loginModal = $('#login-modal');
        const btnOpenLogin = $('#btn-open-login');
        const loginCancel = $('#login-cancel');
        const loginSubmit = $('#login-submit');

        btnOpenLogin.addEventListener('click', () => loginModal.classList.remove('hidden'));
        loginCancel.addEventListener('click', () => loginModal.classList.add('hidden'));

        function updateAdminUI(isLoggedIn) {
            whIsAdmin = isLoggedIn;
            
            // Ubah tombol Login menjadi Logout jika sudah login
            if (isLoggedIn) {
                btnOpenLogin.textContent = 'ğŸ”“ Logout Admin';
                btnOpenLogin.onclick = handleLogout;
                // Tampilkan tombol dan kolom admin
                $('#admin-actions').classList.remove('hidden');
                $('#btn-open-add-guru').classList.remove('hidden'); 
                $('#btn-reset-sample').classList.remove('hidden');
                $('#guru-action-header').classList.remove('hidden');
            } else {
                btnOpenLogin.textContent = 'ğŸ”‘ Login Admin';
                btnOpenLogin.onclick = () => loginModal.classList.remove('hidden');
                // Sembunyikan tombol dan kolom admin
                $('#admin-actions').classList.add('hidden');
                $('#btn-open-add-guru').classList.add('hidden'); 
                $('#btn-reset-sample').classList.add('hidden');
                $('#guru-action-header').classList.add('hidden');
            }
            renderGuruTable(); // Re-render guru table to show/hide action column
        }

        function handleLogout() {
            if (window.whUseFirebase && window.signOutAdmin) {
                window.signOutAdmin();
            }
            updateAdminUI(false);
            toast('Logout Berhasil', 'info');
            showPage('kehadiran');
        }

        loginSubmit.addEventListener('click', async () => {
            const email = $('#login-email').value.trim();
            const password = $('#login-password').value.trim();

            if (!email || !password) {
                return toast('Masukkan email dan password','err');
            }
            
            // Panggil fungsi login Firebase
            if (window.whUseFirebase && window.signInAdmin) {
                try {
                    await window.signInAdmin(email, password); 
                    // onAuthStateChanged akan memanggil updateAdminUI
                    loginModal.classList.add('hidden');
                    toast('Login Berhasil! Mengambil status Admin...','ok');
                    // Reset form
                    $('#login-email').value = '';
                    $('#login-password').value = '';
                    showPage('dashboard');
                } catch (error) {
                    let msg = error.code === 'auth/user-not-found' ? 'Email tidak terdaftar.' : 
                              error.code === 'auth/wrong-password' ? 'Password salah.' : 
                              'Login Gagal. Cek kredensial Anda.';
                    console.error('Login Gagal:', error);
                    toast(msg,'err');
                }
            } else {
                // Fallback demo lokal (tidak disarankan)
                if (email === 'admin@mail.com' && password === 'admin123') {
                    loginModal.classList.add('hidden');
                    toast('Login Berhasil (Demo Lokal)!','ok');
                    updateAdminUI(true);
                    showPage('dashboard');
                } else {
                    toast('Login Gagal (Demo Lokal).','err');
                }
            }
        });

        // --- LOCATION LOGIC ---
        function updateLocation(lat, lon, placeName) {
            window.currentCoords = { lat, lon };
            $('#current-location-display').textContent = `Lokasi: ${placeName || 'Koordinat Tersimpan'}`;
        }
        
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        updateLocation(latitude, longitude, `Lat: ${latitude.toFixed(4)}, Lon: ${longitude.toFixed(4)}`);
                    },
                    (error) => {
                        console.error('Geolocation Error:', error);
                        $('#current-location-display').textContent = 'Lokasi: Gagal mendapatkan lokasi (Izinkan akses).';
                        toast('Gagal mendapatkan lokasi. Pastikan GPS aktif.', 'err');
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            } else {
                $('#current-location-display').textContent = 'Lokasi: Geolocation tidak didukung.';
            }
        }
        
        // --- INITIALIZATION ---
        function initApp() {
            // Set current date display
            const today = new Date().toLocaleDateString("id-ID", { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            $('#current-date-display').textContent = `Tanggal: ${today}`;
            
            getLocation();
            showPage('kehadiran');
            
            // Listeners for data updates from Firebase
            document.addEventListener('gurus-updated', (e) => {
                whGuruList = e.detail;
                renderGuruSelect();
                renderGuruTable();
                generateReport(); // Update report data
                renderDashboard();
                toast(`Data Guru diperbarui (${whGuruList.length})`, 'info', 1000);
            });

            document.addEventListener('attendances-updated', (e) => {
                whAttList = e.detail;
                renderDashboard();
                generateReport(); // Update report data
                toast(`Data Kehadiran diperbarui (${whAttList.length})`, 'info', 1000);
            });
            
            // Listener for Firebase Auth changes
            document.addEventListener('auth-changed', (e) => {
                 const user = e.detail;
                 const isAdmin = user && user.admin === true;
                 updateAdminUI(isAdmin);
            });


            // Initial data sync (if using Firebase)
            if (window.whUseFirebase && window.syncFromFirebase) {
                 window.syncFromFirebase().catch(e => {
                     console.error("Initial sync failed", e);
                     toast("Gagal sinkronisasi data dari Firebase. Cek koneksi atau izin.", "err");
                 });
            } else {
                 // Fallback: render UI dari LocalStorage
                 renderGuruSelect();
                 renderGuruTable();
                 renderDashboard();
                 generateReport();
            }

            // Bind Reset Sample Button (Admin-Only)
            $('#btn-reset-sample').addEventListener('click', () => {
                 if (whIsAdmin && confirm('PERINGATAN: Aksi ini akan menghapus SEMUA data Guru dan Kehadiran di Firebase Realtime Database. Lanjutkan?')) {
                     if (window.__WH_FIREBASE && window.__WH_FIREBASE.db) {
                         window.__WH_FIREBASE.db.ref('gurus').remove()
                             .then(() => window.__WH_FIREBASE.db.ref('attendances').remove())
                             .then(() => toast('Data Guru dan Kehadiran berhasil direset!', 'ok'))
                             .catch(e => toast(`Gagal mereset: ${e.message}`, 'err'));
                     }
                 }
            });
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
