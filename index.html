<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WebsiteHadir SD Negeri Muhara</title>

  <!-- Tailwind CSS (dev via CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js & XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <!-- Firebase SDK (compat untuk Realtime DB) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>

  <link rel="icon" type="image/png" href="Logo.png">

  <style>
    .card { background:#fff; box-shadow:0 6px 18px rgba(0,0,0,0.06); border-radius:1rem; padding:1.5rem; text-align:center; transition:transform 160ms; }
    .card:hover{ transform:scale(1.02); }
    #analogClock{ background: radial-gradient(circle at center,#fff 40%,#e0e7ff 100%); border-radius:50%; box-shadow:0 0 15px rgba(30,58,138,0.2), inset 0 0 8px rgba(0,0,0,0.05); }
    .tab-active{ background-color:#dc2626; color:white !important; font-weight:600; }
    .tab-button:hover{ background-color: rgba(220,38,38,0.08); }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">

  <!-- HEADER -->
  <header class="bg-white shadow-md">
    <div class="max-w-7xl mx-auto flex flex-wrap items-center justify-between py-4 px-5">
      <div class="flex items-center gap-4">
        <img src="Logo.png" alt="Logo SDN Muhara" class="h-16 w-auto rounded-md bg-white shadow p-1" />
        <div>
          <h1 class="text-2xl font-bold text-blue-900">SD Negeri Muhara</h1>
          <p class="text-red-600 italic font-medium text-sm">"Guru Hadir, Siswa Terinspirasi."</p>
        </div>
      </div>

      <div class="text-right mt-3 sm:mt-0">
        <p id="current-date" class="text-sm text-gray-600 font-semibold mb-1"></p>
        <canvas id="analogClock" width="80" height="80"></canvas>
      </div>
    </div>
    <div class="h-2 w-full bg-gradient-to-r from-red-600 via-white to-red-600"></div>
  </header>

  <!-- NAV -->
  <nav class="bg-white shadow-inner border-b border-gray-200 sticky top-0 z-40">
    <div class="max-w-7xl mx-auto flex justify-center gap-2 py-3 flex-wrap">
      <button data-page="kehadiran" class="tab-button px-5 py-2 rounded-md text-blue-900 hover:font-semibold tab-active">üì• Isi Kehadiran</button>
      <button data-page="dashboard" class="tab-button px-5 py-2 rounded-md text-blue-900 hover:font-semibold">üìä Dashboard</button>
      <button data-page="guru" class="tab-button px-5 py-2 rounded-md text-blue-900 hover:font-semibold">üë©‚Äçüè´ Data Guru</button>
      <button data-page="laporan" class="tab-button px-5 py-2 rounded-md text-blue-900 hover:font-semibold">üìÖ Laporan Bulanan</button>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto px-5 py-6">

    <!-- FORM -->
    <section id="page-kehadiran">
      <h2 class="text-2xl font-bold text-blue-900 mb-4">üì• Isi Kehadiran Guru</h2>

      <div class="bg-white rounded-xl shadow p-6 max-w-lg mx-auto space-y-4">
        <div>
          <label for="namaGuru" class="block font-medium text-gray-700 mb-1">Nama Guru</label>
          <select id="namaGuru" class="border rounded p-2 w-full"></select>
        </div>

        <div>
          <label for="statusKehadiran" class="block font-medium text-gray-700 mb-1">Status Kehadiran</label>
          <select id="statusKehadiran" class="border rounded p-2 w-full">
            <option value="">-- Pilih Status --</option>
            <option value="Hadir">Hadir</option>
            <option value="Izin">Izin</option>
            <option value="Sakit">Sakit</option>
            <option value="Dinas Luar">Dinas Luar</option>
          </select>
        </div>

        <div>
          <label for="lokasi" class="block font-medium text-gray-700 mb-1">Lokasi (otomatis)</label>
          <input type="text" id="lokasi" readonly class="border rounded p-2 w-full bg-gray-50 text-gray-600" placeholder="Menunggu lokasi..." />
        </div>

        <button id="kirimKehadiranBtn" class="bg-red-600 hover:bg-red-700 text-white w-full py-2 rounded font-semibold">
          üöÄ Kirim Kehadiran
        </button>
      </div>
    </section>

    <!-- DASHBOARD -->
    <section id="page-dashboard" class="hidden">
      <div class="grid md:grid-cols-3 gap-6 mb-8">
        <div class="card">
          <h3 class="text-gray-500">Total Guru</h3>
          <p id="totalGuru" class="text-4xl font-bold text-blue-900">0</p>
        </div>
        <div class="card">
          <h3 class="text-gray-500">Hadir Hari Ini</h3>
          <p id="totalHadir" class="text-4xl font-bold text-green-600">0</p>
        </div>
        <div class="card">
          <h3 class="text-gray-500">Izin / Sakit / Dinas</h3>
          <p id="totalLain" class="text-4xl font-bold text-yellow-500">0</p>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow p-6 mb-8">
        <h3 class="font-semibold text-blue-900 mb-4">Grafik Kehadiran Hari Ini</h3>
        <canvas id="chartDashboard" height="120"></canvas>
      </div>

      <div class="bg-white rounded-xl shadow p-6">
        <h3 class="font-semibold text-blue-900 mb-4">Aktivitas Terbaru</h3>
        <div id="recent-activity" class="text-sm text-gray-700 space-y-1">
          <p class="text-gray-400">Memuat data...</p>
        </div>
      </div>
    </section>

    <!-- DATA GURU -->
    <section id="page-guru" class="hidden">
      <h2 class="text-2xl font-bold text-blue-900 mb-4">üë©‚Äçüè´ Daftar Guru</h2>
      <div class="bg-white rounded-xl shadow p-6 overflow-x-auto">
        <!-- Admin controls will be injected here when admin logs in -->
        <table class="min-w-full border text-sm mt-3">
          <thead class="bg-red-50 text-blue-900 font-semibold">
            <tr>
              <th class="border p-2">NIP</th>
              <th class="border p-2">Nama Guru</th>
              <th class="border p-2">Jabatan</th>
              <th class="border p-2">Status</th>
            </tr>
          </thead>
          <tbody id="guruTableBody">
            <tr><td colspan="4" class="text-center p-4 text-gray-500">Memuat data...</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- LAPORAN -->
    <section id="page-laporan" class="hidden">
      <h2 class="text-2xl font-bold text-blue-900 mb-4">üìÖ Laporan Bulanan</h2>
      <div class="flex flex-wrap items-center gap-3 mb-4">
        <input type="month" id="bulan" class="border rounded p-2" />
        <button id="tampilkanLaporanBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Tampilkan</button>
        <button id="exportLaporanBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">üì• Export Excel</button>
      </div>

      <div class="bg-white rounded-xl shadow p-6 overflow-auto mb-6">
        <table class="min-w-full border text-sm">
          <thead class="bg-red-50 text-blue-900 font-semibold">
            <tr>
              <th class="border p-2">Tanggal</th>
              <th class="border p-2">Nama Guru</th>
              <th class="border p-2">Jam</th>
              <th class="border p-2">Lokasi</th>
              <th class="border p-2">Status</th>
            </tr>
          </thead>
          <tbody id="laporanTableBody">
            <tr><td colspan="5" class="text-center p-4 text-gray-500">Pilih bulan untuk menampilkan data.</td></tr>
          </tbody>
        </table>
      </div>

      <div id="resume-laporan" class="bg-blue-50 rounded-xl shadow p-6 text-gray-700"></div>
    </section>

  </main>

  <footer class="bg-blue-900 text-white text-center py-3 text-sm font-medium tracking-wide">
    D.A.N √ó GPT-5 | 2025
  </footer>

  <!-- app.firebase.js (harus ada, diambil / disesuaikan sebelumnya) -->
  <script type="module" src="app.firebase.js"></script>

  <!-- ===== Admin Manual Login & Client-side Guru CRUD (Firebase-aware) ===== -->
  <script>
  (function(){
    // --- Konfigurasi demo (ganti credential ini untuk deploy internal) ---
    const ADMIN_USER = 'admin';
    const ADMIN_PASS = 'admin123'; // GANTI sebelum produksi

    // --- Helper DOM ---
    function $ (s) { return document.querySelector(s); }
    function $$ (s) { return Array.from(document.querySelectorAll(s)); }

    // --- Inject Admin Button di NAV (kanan) ---
    (function injectAdminBtn(){
      const nav = document.querySelector('nav .max-w-7xl') || document.querySelector('nav');
      if (!nav) return;
      const wrapper = document.createElement('div');
      wrapper.className = 'ml-auto flex items-center gap-2';
      wrapper.innerHTML = `
        <button id="btn-open-admin" class="tab-button px-4 py-1 rounded-md text-white bg-gray-700 hover:bg-gray-800">Admin</button>
        <button id="btn-admin-logout" class="hidden text-sm text-gray-600 underline">Logout</button>
      `;
      nav.appendChild(wrapper);
    })();

    // --- Modal HTML (hidden) ---
    const modalHtml = `
      <div id="admin-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-lg p-6 w-96">
          <h3 class="text-lg font-semibold text-gray-800 mb-3">Login Admin</h3>
          <div class="space-y-2">
            <input id="admin-username" class="border p-2 rounded w-full" placeholder="Username" />
            <input id="admin-password" class="border p-2 rounded w-full" placeholder="Password" type="password" />
            <div class="flex gap-2 justify-end mt-2">
              <button id="admin-cancel" class="px-3 py-1 rounded bg-gray-100">Batal</button>
              <button id="admin-submit" class="px-3 py-1 rounded bg-red-600 text-white">Login</button>
            </div>
            <p id="admin-msg" class="text-sm text-red-600 mt-2"></p>
          </div>
        </div>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // --- Admin CRUD UI insertion (Data Guru page) ---
    function injectAdminControls(){
      const guruSection = document.getElementById('page-guru');
      if (!guruSection) return;
      if (document.getElementById('admin-controls')) return; // already injected
      const ctrl = document.createElement('div');
      ctrl.id = 'admin-controls';
      ctrl.className = 'mt-4 mb-4 flex gap-2 items-center';
      ctrl.innerHTML = `
        <button id="btn-add-guru-admin" class="bg-green-600 text-white px-3 py-1 rounded">Tambah Guru</button>
        <button id="btn-sync-local" class="bg-gray-200 px-3 py-1 rounded text-sm">Sinkron: Firebase</button>
        <span class="text-sm text-gray-500 ml-3">Anda sedang melihat mode <strong>Admin</strong>.</span>
      `;
      // place controls at top of the card area
      const card = guruSection.querySelector('.bg-white') || guruSection;
      card.prepend(ctrl);
    }

    // --- Modal add/edit guru (small) ---
    const guruModalHtml = `
      <div id="guru-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-lg p-6 w-96">
          <h3 class="text-lg font-semibold text-gray-800 mb-3" id="guru-modal-title">Tambah Guru</h3>
          <div class="space-y-2">
            <input id="guru-nip" class="border p-2 rounded w-full" placeholder="NIP (opsional)" />
            <input id="guru-nama-input" class="border p-2 rounded w-full" placeholder="Nama lengkap" />
            <input id="guru-jabatan-input" class="border p-2 rounded w-full" placeholder="Jabatan / Mapel" />
            <div class="flex gap-2 justify-end mt-2">
              <button id="guru-cancel" class="px-3 py-1 rounded bg-gray-100">Batal</button>
              <button id="guru-save" class="px-3 py-1 rounded bg-red-600 text-white">Simpan</button>
            </div>
          </div>
        </div>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', guruModalHtml);

    // --- Storage keys & helpers (fallback local) ---
    const KEY_ADMIN = 'wh_admin_logged';
    const KEY_GURU = 'wh_guru_list_v1'; // array of { id, nip, nama, jabatan }

    function isAdmin(){ return localStorage.getItem(KEY_ADMIN) === '1'; }
    function setAdmin(val){ if(val) localStorage.setItem(KEY_ADMIN,'1'); else localStorage.removeItem(KEY_ADMIN); }

    function getLocalGuruList(){
      try { return JSON.parse(localStorage.getItem(KEY_GURU) || '[]'); }
      catch(e){ return []; }
    }
    function saveLocalGuruList(list){ localStorage.setItem(KEY_GURU, JSON.stringify(list)); }

    // --- Utilities for rendering guru table & select ---
    function renderGuruTableFromList(list){
      const tbody = document.getElementById('guruTableBody');
      if (!tbody) return;
      if (!Array.isArray(list) || list.length === 0){
        tbody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-gray-500">Belum ada guru terdaftar.</td></tr>';
        populateNamaGuruSelect(list || []);
        return;
      }
      tbody.innerHTML = '';
      list.forEach(g => {
        const tr = document.createElement('tr');
        tr.className = 'align-top';
        tr.innerHTML = `
          <td class="border p-2">${g.nip || ''}</td>
          <td class="border p-2">${escapeHtml(g.nama || g.name || '')}</td>
          <td class="border p-2">${escapeHtml(g.jabatan || '')}</td>
          <td class="border p-2">
            ${ isAdmin() ? `<button data-id="${g.id}" class="edit-guru inline-block bg-yellow-400 px-2 py-1 rounded text-sm mr-2">Edit</button>
                            <button data-id="${g.id}" class="del-guru inline-block bg-red-600 text-white px-2 py-1 rounded text-sm">Hapus</button>` : '<span class="text-sm text-gray-500">‚Äî</span>'}
          </td>
        `;
        tbody.appendChild(tr);
      });

      // attach handlers
      $$('.edit-guru').forEach(b => b.onclick = e => {
        const id = e.currentTarget.dataset.id;
        openGuruModalForEdit(id);
      });
      $$('.del-guru').forEach(b => b.onclick = e => {
        const id = e.currentTarget.dataset.id;
        if (!confirm('Hapus guru ini?')) return;
        // choose firebase if available
        if (window.deleteGuruFirebase) {
          deleteGuruFirebase(id).catch(err=>alert('Gagal hapus: '+(err.message||err)));
        } else {
          deleteGuruById(id);
        }
      });

      // also populate select #namaGuru
      populateNamaGuruSelect(list);
    }

    function populateNamaGuruSelect(list){
      const sel = document.getElementById('namaGuru');
      if (!sel) return;
      sel.innerHTML = '<option value="">-- Pilih Guru --</option>';
      (list || []).forEach(g => {
        const opt = document.createElement('option');
        opt.value = `${g.nip||g.id}|${g.nama||g.name||''}`;
        opt.textContent = (g.nama||g.name||'') + (g.jabatan ? ' ‚Äî ' + g.jabatan : '');
        sel.appendChild(opt);
      });
    }

    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"'`]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;","`":"&#96;"}[c])); }

    // --- CRUD fallback (localStorage) ---
    function addGuruLocal(data){
      const list = getLocalGuruList();
      const id = 'g'+Date.now();
      list.push(Object.assign({ id }, data));
      saveLocalGuruList(list);
      renderGuruTableFromList(list);
    }
    function updateGuruLocal(id, data){
      const list = getLocalGuruList();
      const idx = list.findIndex(x=>x.id===id);
      if (idx === -1) return false;
      list[idx] = Object.assign({}, list[idx], data);
      saveLocalGuruList(list);
      renderGuruTableFromList(list);
      return true;
    }
    function deleteGuruLocal(id){
      let list = getLocalGuruList();
      list = list.filter(x=>x.id!==id);
      saveLocalGuruList(list);
      renderGuruTableFromList(list);
    }

    // --- Modal behaviors ---
    function openAdminModal(){ $('#admin-modal').classList.remove('hidden'); $('#admin-username').focus(); $('#admin-msg').textContent=''; }
    function closeAdminModal(){ $('#admin-modal').classList.add('hidden'); $('#admin-username').value=''; $('#admin-password').value=''; $('#admin-msg').textContent=''; }

    function openGuruModalForCreate(){
      $('#guru-modal-title').textContent = 'Tambah Guru';
      $('#guru-nip').value = ''; $('#guru-nama-input').value=''; $('#guru-jabatan-input').value='';
      $('#guru-modal').classList.remove('hidden');
      $('#guru-save').dataset.editId = '';
    }
    function openGuruModalForEdit(id){
      // if firebase exists, try to read from localStorage list saved by firebase listener, else use localStorage fallback
      const list = (window.__latest_guru_list || getLocalGuruList());
      const g = (list || []).find(x=>x.id===id);
      if (!g) return alert('Data guru tidak ditemukan');
      $('#guru-modal-title').textContent = 'Edit Guru';
      $('#guru-nip').value = g.nip || '';
      $('#guru-nama-input').value = g.nama || g.name || '';
      $('#guru-jabatan-input').value = g.jabatan || '';
      $('#guru-modal').classList.remove('hidden');
      $('#guru-save').dataset.editId = id;
    }

    function closeGuruModal(){ $('#guru-modal').classList.add('hidden'); $('#guru-save').dataset.editId=''; }

    // --- Show/hide admin UI ---
    function showAdminUI(){
      injectAdminControls();
      $('#btn-admin-logout').classList.remove('hidden');
      $('#btn-open-admin').classList.add('hidden');
      // render current list (prefer firebase-updated list if available)
      const list = window.__latest_guru_list || getLocalGuruList();
      renderGuruTableFromList(list);
    }
    function hideAdminUI(){
      const ctrl = document.getElementById('admin-controls'); if (ctrl) ctrl.remove();
      $('#btn-admin-logout').classList.add('hidden');
      $('#btn-open-admin').classList.remove('hidden');
      const list = window.__latest_guru_list || getLocalGuruList();
      renderGuruTableFromList(list);
    }

    // --- Helper: attempt to trigger firebase sync if available ---
    function trySyncFromFirebase(){
      if (window.syncFromFirebase) {
        try {
          window.syncFromFirebase();
        } catch(e){ console.warn('syncFromFirebase error', e); }
      } else {
        // no firebase: ensure local exists
        const list = getLocalGuruList();
        if (!list || list.length === 0) {
          // seed demo local data (only if totally empty)
          const demo = [
            { id:'g1', nip:'19850101', nama:'Siti Nurjanah', jabatan:'Matematika' },
            { id:'g2', nip:'19870102', nama:'Budi Santoso', jabatan:'Bahasa Indonesia' },
            { id:'g3', nip:'19890103', nama:'Rina Maharani', jabatan:'IPA' }
          ];
          saveLocalGuruList(demo);
        }
        renderGuruTableFromList(getLocalGuruList());
      }
    }

    // --- Attach event listeners (modal buttons etc) ---
    document.addEventListener('click', async (e) => {
      if (e.target && e.target.id === 'btn-open-admin') openAdminModal();
      if (e.target && e.target.id === 'admin-cancel') closeAdminModal();
      if (e.target && e.target.id === 'admin-submit') {
        const u = $('#admin-username').value.trim();
        const p = $('#admin-password').value.trim();
        if (u === ADMIN_USER && p === ADMIN_PASS) {
          setAdmin(true);
          closeAdminModal();
          showAdminUI();
          alert('Login Admin berhasil (demo).');
        } else {
          $('#admin-msg').textContent = 'Credential salah.';
        }
      }
      if (e.target && e.target.id === 'btn-admin-logout') {
        if (!confirm('Keluar sebagai admin?')) return;
        setAdmin(false);
        hideAdminUI();
        alert('Logout berhasil.');
      }

      if (e.target && e.target.id === 'btn-add-guru-admin') openGuruModalForCreate();
      if (e.target && e.target.id === 'guru-cancel') closeGuruModal();
      if (e.target && e.target.id === 'guru-save') {
        const editId = e.target.dataset.editId || '';
        const nip = $('#guru-nip').value.trim();
        const nama = $('#guru-nama-input').value.trim();
        const jab = $('#guru-jabatan-input').value.trim();
        if (!nama) return alert('Masukkan nama guru');

        // If firebase CRUD functions available, use them. Otherwise fallback to local.
        try {
          if (editId) {
            if (window.updateGuruFirebase) {
              await window.updateGuruFirebase(editId, { nip, nama, jabatan: jab });
            } else {
              updateGuruLocal(editId, { nip, nama, jabatan: jab });
            }
          } else {
            if (window.addGuruFirebase) {
              await window.addGuruFirebase({ nip, nama, jabatan: jab });
            } else {
              addGuruLocal({ nip, nama, jabatan: jab });
            }
          }
          closeGuruModal();
          // UI will update via firebase listener; if local fallback, we already updated table.
        } catch(err){
          alert('Gagal menyimpan guru: ' + (err && err.message ? err.message : err));
        }
      }
      if (e.target && e.target.id === 'btn-sync-local') {
        // trigger firebase sync if available, else re-render local
        trySyncFromFirebase();
        alert('Sinkronisasi dipicu.');
      }
    });

    // --- Listen to firebase-driven event (app.firebase.js dispatches 'gurus-updated') ---
    window.addEventListener('gurus-updated', (ev) => {
      const list = ev.detail || [];
      // keep a cached reference for modal edit
      window.__latest_guru_list = list;
      // also store to localStorage for fallback & total count
      try { saveLocalGuruList(list); } catch(e){}
      renderGuruTableFromList(list);
      // update totalGuru counter if present
      const totalGuruEl = document.getElementById('totalGuru');
      if (totalGuruEl) totalGuruEl.textContent = String(list.length);
    });

    // --- Initial boot ---
    (function boot(){
      trySyncFromFirebase();
      if (isAdmin()) showAdminUI(); else hideAdminUI();
      // if firebase already loaded and dispatched before this script, also check localStorage fallback
      const local = getLocalGuruList();
      if ((!window.__latest_guru_list || window.__latest_guru_list.length === 0) && local && local.length) {
        window.__latest_guru_list = local;
        renderGuruTableFromList(local);
      }
    })();

  })();
  </script>

</body>
</html>
