<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WebsiteHadir ‚Äî SDN Muhara (Full Fixed)</title>

  <!-- Tailwind CSS (CDN demo) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js & XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <!-- Firebase compat scripts (APP, DB, AUTH) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>

  <link rel="icon" type="image/png" href="Logo.png">

  <style>
    /* small visual tweaks */
    .sidebar { background: linear-gradient(180deg,#7f1d1d, #b91c1c); }
    .sidebar .nav-item { color: rgba(255,255,255,0.92); }
    .card-smooth { background: linear-gradient(180deg,#fff,#f8fafc); border-radius:12px; box-shadow:0 6px 22px rgba(15,23,42,0.06); }
    /* toast container will be added in Part C */
    /* ensure status buttons clickable above any overlays */
    .status-btn { position: relative; z-index: 20; cursor: pointer; user-select: none; }
  </style>
</head>

<body class="antialiased bg-slate-50 text-slate-800">
  <div class="min-h-screen flex">
<!-- MAIN CONTENT BODY -->
<main class="p-6 w-full">
  <div class="max-w-7xl mx-auto">

    <!-- TOP BAR: date/clock + page nav + admin buttons -->
    <div class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-4">
        <div id="current-date-top" class="text-sm text-slate-600"></div>
        <div id="clock-small" class="text-sm text-slate-600"></div>
      </div>
      <div class="flex items-center gap-2">
        <button data-page="kehadiran" class="px-3 py-1 rounded text-sm">Kehadiran</button>
        <button data-page="dashboard" class="px-3 py-1 rounded text-sm">Dashboard</button>
        <button data-page="guru" class="px-3 py-1 rounded text-sm">Guru</button>
        <button data-page="laporan" class="px-3 py-1 rounded text-sm">Laporan</button>
        <button id="btn-open-admin" class="px-3 py-1 rounded bg-slate-100 text-sm">Admin</button>
        <button id="btn-admin-logout" class="px-3 py-1 rounded bg-rose-100 text-sm hidden">Logout</button>
        <div id="admin-badge" class="ml-2 px-2 py-1 rounded bg-emerald-600 text-white text-xs hidden">ADMIN</div>
      </div>
    </div>

    <!-- DASHBOARD CARDS -->
    <div id="page-dashboard" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 hidden">
      <div class="card-smooth p-5">
        <div class="text-sm text-slate-500">Total Guru</div>
        <div id="totalGuru" class="text-3xl font-bold text-slate-800 mt-2">0</div>
      </div>
      <div class="card-smooth p-5">
        <div class="text-sm text-slate-500">Hadir Hari Ini</div>
        <div id="totalHadir" class="text-3xl font-bold text-green-600 mt-2">0</div>
      </div>
      <div class="card-smooth p-5">
        <div class="text-sm text-slate-500">Izin / Sakit / Dinas</div>
        <div id="totalLain" class="text-3xl font-bold text-amber-600 mt-2">0</div>
      </div>
    </div>

    <!-- ===================================================== -->
    <!-- FORM KEHADIRAN                                          -->
    <!-- ===================================================== -->
    <section id="page-kehadiran">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        
        <!-- LEFT CARD -->
        <div class="card-smooth p-6">
          <h2 class="text-xl font-semibold mb-2">üì• Isi Kehadiran Guru</h2>
          <p class="text-sm text-slate-500 mb-4">Pilih nama guru lalu isi status kehadiran.</p>

          <div class="space-y-4">

            <!-- NAMA GURU -->
            <div>
              <label class="block text-sm text-slate-700 mb-1">Nama Guru</label>
              <select id="namaGuru" class="w-full border rounded p-2"></select>
            </div>

            <!-- STATUS SELECTION (BUTTONS) -->
            <div>
              <label class="block text-sm text-slate-700 mb-1">Status Kehadiran</label>

              <div class="grid grid-cols-2 gap-3">

                <button class="status-btn p-3 border rounded-lg bg-white text-center text-slate-700 font-medium"
                  data-status="Hadir">‚úî HADIR</button>

                <button class="status-btn p-3 border rounded-lg bg-white text-center text-slate-700 font-medium"
                  data-status="Izin">üìù IZIN</button>

                <button class="status-btn p-3 border rounded-lg bg-white text-center text-slate-700 font-medium"
                  data-status="Sakit">ü§í SAKIT</button>

                <button class="status-btn p-3 border rounded-lg bg-white text-center text-slate-700 font-medium"
                  data-status="Dinas Luar">üöó DINAS LUAR</button>

              </div>

              <!-- Hidden fallback select for scripts -->
              <select id="statusKehadiran" class="hidden">
                <option value="">--</option>
                <option value="Hadir">Hadir</option>
                <option value="Izin">Izin</option>
                <option value="Sakit">Sakit</option>
                <option value="Dinas Luar">Dinas Luar</option>
              </select>

            </div>

            <!-- LOKASI -->
            <div>
              <label class="block text-sm text-slate-700 mb-1">Nama Tempat (opsional)</label>
              <input id="placeName" class="w-full border rounded p-2" placeholder="Contoh: SDN Muhara" />

              <div class="mt-2">
                <label class="block text-sm text-slate-700 mb-1">Lokasi (otomatis)</label>
                <input id="lokasi" readonly class="w-full border rounded p-2 bg-slate-50 text-slate-600"
                  placeholder="Menunggu lokasi..." />
                <div id="coords-small" class="text-xs text-slate-400 mt-1">Koordinat: ‚Äî</div>

                <button id="ambilLokasiBtn"
                  class="mt-2 px-3 py-1 rounded bg-sky-600 text-white text-sm">
                  Ambil Lokasi GPS
                </button>
              </div>
            </div>

            <!-- SUBMIT -->
            <div class="flex gap-3 items-center">
              <button id="kirimKehadiranBtn"
                class="bg-rose-600 hover:bg-rose-700 text-white px-4 py-2 rounded">
                üöÄ Kirim Kehadiran
              </button>
              <div id="kehadiran-status" class="text-sm text-slate-500">‚Äî</div>
            </div>

          </div>
        </div>

        <!-- RIGHT CARD (CHART + RECENT) -->
        <div class="card-smooth p-6">
          <h3 class="font-semibold">Grafik Kehadiran Hari Ini</h3>
          <div class="mt-4">
            <canvas id="chartDashboard" height="180"></canvas>
          </div>

          <div class="mt-6">
            <h4 class="font-medium text-slate-700 mb-2">Aktivitas Terbaru</h4>
            <div id="recent-activity" class="space-y-1 text-slate-700 text-sm">
              <p class="text-slate-400">Memuat data...</p>
            </div>
          </div>
        </div>

      </div>
    </section>

    <!-- ===================================================== -->
    <!-- DATA GURU PAGE                                        -->
    <!-- ===================================================== -->
    <section id="page-guru" class="hidden mt-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold">üë©‚Äçüè´ Daftar Guru</h2>
        <div id="admin-controls-placeholder"></div>
      </div>

      <div class="bg-white rounded-xl shadow p-4 overflow-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-rose-50 text-rose-700 font-semibold">
            <tr>
              <th class="border p-2 text-left">NIP</th>
              <th class="border p-2 text-left">Nama Guru</th>
              <th class="border p-2 text-left">Jabatan</th>
              <th class="border p-2 text-left">Status</th>
              <th class="border p-2 text-left">Aksi</th>
            </tr>
          </thead>
          <tbody id="guruTableBody">
            <tr><td colspan="5" class="text-center p-6 text-slate-500">Memuat data...</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- ===================================================== -->
    <!-- LAPORAN PAGE (full with expected IDs)                 -->
    <!-- ===================================================== -->
    <section id="page-laporan" class="hidden mt-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold">üìã Laporan Kehadiran</h2>
        <div class="flex gap-2 items-center">
          <input id="bulan" type="month" class="border p-2 rounded" />
          <button id="tampilkanLaporanBtn" class="px-3 py-1 rounded bg-sky-600 text-white">Tampilkan</button>
          <button id="exportLaporanBtn" class="px-3 py-1 rounded bg-emerald-600 text-white">Export Excel</button>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow p-4 overflow-auto">
        <table class="min-w-full text-sm">
          <thead id="laporanPivotHead" class="bg-rose-50 text-rose-700 font-semibold"></thead>
          <tbody id="laporanPivotBody"><tr><td colspan="32" class="text-center p-6 text-slate-500">Pilih bulan untuk menampilkan data.</td></tr></tbody>
        </table>
      </div>
      <div id="laporan-summary" class="mt-4 text-slate-700"></div>
    </section>

    <!-- backward compat -->
    <section id="laporan-extra" class="hidden">
      <div id="laporan-summary-legacy" class="bg-rose-50 rounded-xl p-4 text-slate-700"></div>
    </section>

    </div> <!-- .max-w-7xl -->
  </main>

  <!-- TOASTS -->
  <div id="toasts" aria-live="polite" aria-atomic="true" class="fixed right-4 top-16 space-y-2"></div>

  <!-- ADMIN LOGIN MODAL -->
  <div id="admin-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40">
    <div class="bg-white rounded-xl shadow-lg p-6 w-96">
      <h3 class="text-lg font-semibold mb-2">Login Admin</h3>
      <div class="space-y-2">
        <input id="admin-email" class="border p-2 rounded w-full" placeholder="Email admin" type="email" />
        <input id="admin-password" class="border p-2 rounded w-full" placeholder="Password" type="password" />
        <div class="flex justify-end gap-2">
          <button id="admin-cancel" class="px-3 py-1 rounded bg-slate-100">Batal</button>
          <button id="admin-submit" class="px-3 py-1 rounded bg-rose-600 text-white">Login</button>
        </div>
        <p id="admin-msg" class="text-sm text-red-600"></p>
      </div>
    </div>
  </div>

  <!-- GURU MODAL -->
  <div id="guru-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40">
    <div class="bg-white rounded-xl shadow-lg p-6 w-96">
      <h3 id="guru-modal-title" class="text-lg font-semibold mb-2">Tambah Guru</h3>
      <div class="space-y-2">
        <input id="guru-nip" class="border p-2 rounded w-full" placeholder="NIP (opsional)" />
        <input id="guru-nama-input" class="border p-2 rounded w-full" placeholder="Nama lengkap" />
        <input id="guru-jabatan-input" class="border p-2 rounded w-full" placeholder="Jabatan / Mapel" />
        <div class="flex justify-end gap-2">
          <button id="guru-cancel" class="px-3 py-1 rounded bg-slate-100">Batal</button>
          <button id="guru-save" class="px-3 py-1 rounded bg-rose-600 text-white">Simpan</button>
        </div>
      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <footer class="fixed left-0 right-0 bottom-0 md:static md:mt-8 text-center text-slate-500 text-sm p-3 md:p-6">
    SDN Muhara ‚Ä¢ WebsiteHadir ‚Ä¢ 2025
  </footer>

</div> <!-- .min-h-screen -->
<!-- PART 4: Script UI utama -->
<script>
(function(){
  // helpers
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));

  // toast system
  const toasts = document.getElementById('toasts');
  function toast(msg, type='info', timeout=3200){
    if (!toasts) return console.log('TOAST:', msg);
    const el = document.createElement('div');
    el.className = 'px-4 py-2 rounded shadow flex items-center gap-3 text-sm';
    el.style.minWidth = '220px';
    if (type==='ok') el.classList.add('bg-emerald-100','text-emerald-800');
    else if (type==='err') el.classList.add('bg-rose-100','text-rose-800');
    else el.classList.add('bg-slate-100','text-slate-800');
    el.textContent = msg;
    toasts.appendChild(el);
    setTimeout(()=> { el.style.transition='opacity .25s'; el.style.opacity='0'; setTimeout(()=>el.remove(),300); }, timeout);
  }

  // page nav ‚Äî made robust & aligned with actual section IDs
  function showPage(name){
    const map = { kehadiran: 'page-kehadiran', dashboard: 'page-dashboard', guru: 'page-guru', laporan: 'page-laporan' };
    Object.values(map).forEach(id => { const el = document.getElementById(id); if (!el) return; el.classList.add('hidden'); });
    const targetId = map[name] || ('page-'+name);
    const target = document.getElementById(targetId);
    if (target) target.classList.remove('hidden');
    // update active state for nav buttons (data-page)
    $$('[data-page]').forEach(b => { b.classList.toggle('font-semibold', b.dataset.page===name); });
  }
  // attach nav handlers defensively
  $$( '[data-page]' ).forEach(btn => {
    try { btn.addEventListener('click', (e) => { e.preventDefault(); showPage(btn.dataset.page); }); }
    catch(e){ /* ignore */ }
  });

  // top date & clock
  function setTopDate(){ const now = new Date(); $('#current-date-top') && ($('#current-date-top').textContent = now.toLocaleDateString('id-ID',{weekday:'long', year:'numeric', month:'long', day:'numeric'})); }
  function setClockSmall(){ $('#clock-small') && ($('#clock-small').textContent = new Date().toLocaleTimeString('id-ID')); }
  setTopDate(); setClockSmall(); setInterval(()=>{ setTopDate(); setClockSmall(); },1000);

  // mobile sidebar toggle
  $('#btn-toggle-sidebar')?.addEventListener('click', ()=> {
    const aside = document.querySelector('aside');
    if (!aside) return;
    aside.classList.toggle('hidden');
  });

  // localStorage keys and helpers
  const LS_GURU = 'wh_guru_list_v1';
  function loadGuruList(){ try { return JSON.parse(localStorage.getItem(LS_GURU)||'[]'); } catch(e){ return []; } }
  function saveGuruList(list){ try { localStorage.setItem(LS_GURU, JSON.stringify(list)); } catch(e){} }

  // admin fallback
  function isAdminLocal(){ return localStorage.getItem('wh_admin_logged') === '1'; }
  function setAdminLocal(v){ if (v) localStorage.setItem('wh_admin_logged','1'); else localStorage.removeItem('wh_admin_logged'); }

  // inject admin controls
  function injectAdminControls(){
    const placeholder = $('#admin-controls-placeholder');
    if (!placeholder) return;
    if ($('#admin-controls')) return;
    const wrap = document.createElement('div');
    wrap.id = 'admin-controls';
    wrap.className = 'flex gap-2 items-center';
    wrap.innerHTML = `
      <button id="btn-add-guru-admin" class="bg-emerald-600 text-white px-3 py-1 rounded text-sm">Tambah Guru</button>
      <button id="btn-sync-local" class="bg-slate-100 px-3 py-1 rounded text-sm">Sinkron</button>
    `;
    placeholder.appendChild(wrap);
    // wire buttons
    document.getElementById('btn-add-guru-admin').addEventListener('click', ()=> {
      $('#guru-modal-title').textContent='Tambah Guru';
      $('#guru-nip').value=''; $('#guru-nama-input').value=''; $('#guru-jabatan-input').value='';
      $('#guru-save').dataset.editId=''; $('#guru-modal').classList.remove('hidden');
    });
    document.getElementById('btn-sync-local').addEventListener('click', async ()=>{
      if (window.syncFromFirebase) { try { await window.syncFromFirebase(); toast('Sinkronisasi Firebase dipicu', 'ok'); } catch(e){ toast('Sinkron gagal: '+(e.message||e),'err'); } }
      else { toast('Fungsi sinkron tidak tersedia', 'err'); }
    });
  }
  function removeAdminControls(){ $('#admin-controls')?.remove(); }

  // populate select
  function populateNamaSelect(listOverride){
    const sel = $('#namaGuru'); if (!sel) return;
    const list = Array.isArray(listOverride) ? listOverride : loadGuruList();
    sel.innerHTML = '<option value="">-- Pilih Guru --</option>';
    list.forEach(g => {
      const opt = document.createElement('option');
      opt.value = `${g.id}||${g.nama||''}`;
      opt.textContent = (g.nama||'') + (g.jabatan ? ' ‚Äî ' + g.jabatan : '');
      sel.appendChild(opt);
    });
  }

  // render guru table
  function renderGuruTable(listOverride){
    const tb = $('#guruTableBody'); if (!tb) return;
    const list = Array.isArray(listOverride) ? listOverride : loadGuruList();
    if (!list || !list.length){ tb.innerHTML = '<tr><td colspan="5" class="text-center p-6 text-slate-500">Belum ada guru terdaftar.</td></tr>'; populateNamaSelect(list||[]); $('#totalGuru') && ($('#totalGuru').textContent='0'); return; }
    tb.innerHTML = '';
    list.forEach(g => {
      const tr = document.createElement('tr');
      tr.className = 'align-top';
      const actions = isAdminLocal() ? `<button data-id="${g.id}" class="btn-edit inline-block bg-yellow-400 px-2 py-1 rounded text-sm mr-2">Edit</button>
                                      <button data-id="${g.id}" class="btn-del inline-block bg-rose-600 text-white px-2 py-1 rounded text-sm">Hapus</button>` : '<span class="text-sm text-slate-400">‚Äî</span>';
      tr.innerHTML = `<td class="border p-2">${g.nip||''}</td>
                      <td class="border p-2">${escapeHtml(g.nama||'')}</td>
                      <td class="border p-2">${escapeHtml(g.jabatan||'')}</td>
                      <td class="border p-2">${escapeHtml(g.status||'Aktif')}</td>
                      <td class="border p-2">${actions}</td>`;
      tb.appendChild(tr);
    });

    // wire edit/delete
    $$('.btn-edit').forEach(b => b.onclick = (ev) => {
      const id = ev.currentTarget.dataset.id;
      const g = loadGuruList().find(x=>x.id===id);
      if (!g) return toast('Data guru tidak ditemukan','err');
      $('#guru-modal-title').textContent='Edit Guru';
      $('#guru-nip').value = g.nip || '';
      $('#guru-nama-input').value = g.nama || '';
      $('#guru-jabatan-input').value = g.jabatan || '';
      $('#guru-save').dataset.editId = g.id;
      $('#guru-modal').classList.remove('hidden');
    });

    $$('.btn-del').forEach(b => b.onclick = async (ev) => {
      const id = ev.currentTarget.dataset.id;
      if (!confirm('Hapus guru ini?')) return;
      try {
        if (window.deleteGuruFirebase) { await window.deleteGuruFirebase(id); toast('Permintaan hapus dikirim ke server', 'ok'); }
        else { const list = loadGuruList().filter(x=>x.id!==id); saveGuruList(list); renderGuruTable(list); populateNamaSelect(list); toast('Guru dihapus (lokal)', 'ok'); }
      } catch(err){ console.error(err); toast('Gagal hapus: '+(err && err.message ? err.message : err), 'err'); }
    });

    $('#totalGuru') && ($('#totalGuru').textContent = String(list.length));
  }

  function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"'`]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;","`":"&#96;"}[c])); }

  // admin modal handlers
  function openAdminModal(){ $('#admin-modal').classList.remove('hidden'); $('#admin-email') && $('#admin-email').focus(); $('#admin-msg') && ($('#admin-msg').textContent=''); }
  function closeAdminModal(){ $('#admin-modal').classList.add('hidden'); if($('#admin-email')) $('#admin-email').value=''; if($('#admin-password')) $('#admin-password').value=''; if($('#admin-msg')) $('#admin-msg').textContent=''; }

  document.addEventListener('click', async (e) => {
    // admin open/close
    if (e.target && e.target.id === 'btn-open-admin') openAdminModal();
    if (e.target && e.target.id === 'admin-cancel') closeAdminModal();

    // admin submit
    if (e.target && e.target.id === 'admin-submit') {
      const email = ($('#admin-email').value||'').trim(); const pw = ($('#admin-password').value||'').trim();
      if (!email || !pw) { $('#admin-msg').textContent = 'Email & password diperlukan.'; return; }
      e.target.disabled = true; $('#admin-msg').textContent = 'Menghubungkan...';
      try {
        if (window.signInWithEmail) {
          const info = await window.signInWithEmail(email, pw);
          // auth-changed event will update UI; keep fallback marker
          setAdminLocal(true);
          closeAdminModal();
          injectAdminControls();
          toast('Login admin berhasil', 'ok');
        } else {
          // legacy demo fallback
          if (email==='admin' && pw==='admin123') { setAdminLocal(true); injectAdminControls(); closeAdminModal(); toast('Login demo admin', 'ok'); }
          else { $('#admin-msg').textContent = 'Auth tidak tersedia atau credential salah.'; }
        }
      } catch(err){
        console.error('auth err', err);
        $('#admin-msg').textContent = 'Login gagal: ' + (err && err.message ? err.message : String(err));
      } finally { e.target.disabled = false; }
    }

    // admin logout
    if (e.target && e.target.id === 'btn-admin-logout') {
      if (!confirm('Keluar sebagai admin?')) return;
      setAdminLocal(false);
      $('#admin-badge')?.classList?.add('hidden');
      $('#btn-admin-logout')?.classList?.add('hidden'); $('#btn-open-admin')?.classList?.remove('hidden');
      removeAdminControls();
      renderGuruTable(); populateNamaSelect();
      if (window.signOutFirebase) try { await window.signOutFirebase(); toast('Logout server OK', 'ok'); } catch(e){ /* ignore */ }
      toast('Logout lokal berhasil', 'ok');
    }

    // add guru modal (duplicate-safe)
    if (e.target && e.target.id === 'btn-add-guru-admin') {
      $('#guru-modal-title').textContent='Tambah Guru'; $('#guru-nip').value=''; $('#guru-nama-input').value=''; $('#guru-jabatan-input').value=''; $('#guru-save').dataset.editId=''; $('#guru-modal').classList.remove('hidden');
    }
    if (e.target && e.target.id === 'guru-cancel') $('#guru-modal').classList.add('hidden');

    // save guru
    if (e.target && e.target.id === 'guru-save') {
      const editId = e.target.dataset.editId || '';
      const nip = ($('#guru-nip').value||'').trim(); const nama = ($('#guru-nama-input').value||'').trim(); const jab = ($('#guru-jabatan-input').value||'').trim();
      if (!nama) return toast('Masukkan nama guru','err');
      try {
        if (editId) {
          if (window.updateGuruFirebase) { await window.updateGuruFirebase(editId, { nip, nama, jabatan: jab }); toast('Perubahan dikirim ke server', 'ok'); }
          else { const list = loadGuruList().map(x=> x.id===editId ? Object.assign({}, x, { nip, nama, jabatan: jab }) : x ); saveGuruList(list); renderGuruTable(list); populateNamaSelect(list); toast('Perubahan disimpan (lokal)', 'ok'); }
        } else {
          if (window.addGuruFirebase) { await window.addGuruFirebase({ nip, nama, jabatan: jab }); toast('Guru ditambahkan ke server', 'ok'); }
          else { const list = loadGuruList(); const id = 'g'+Date.now(); list.push({ id, nip, nama, jabatan: jab, status:'Aktif' }); saveGuruList(list); renderGuruTable(list); populateNamaSelect(list); toast('Guru ditambahkan (lokal)', 'ok'); }
        }
      } catch(err){
        console.error('save guru err', err);
        toast('Gagal menyimpan: '+(err && err.message?err.message:err), 'err');
      } finally { $('#guru-modal').classList.add('hidden'); $('#guru-save').dataset.editId=''; }
    }
  });

  // initial UI boot
  showPage('kehadiran');

  if (isAdminLocal()) { $('#admin-badge')?.classList?.remove('hidden'); $('#btn-admin-logout')?.classList?.remove('hidden'); $('#btn-open-admin')?.classList?.add('hidden'); injectAdminControls(); }
  else { $('#admin-badge')?.classList?.add('hidden'); }

  const cached = loadGuruList();
  if (cached && cached.length) { renderGuruTable(cached); populateNamaSelect(cached); }

  // expose for debugging
  window.__WH_UI = { renderGuruTable, populateNamaSelect, loadGuruList, saveGuruList, toast };

})();
</script>
<!-- PART 5: Geolocation, Chart, Recent Activity, Pivot Laporan, Export, Queue -->
<script>
(function(){
  // ---- keys / helpers ----
  const LS_ATT = 'wh_att_list_v1';
  const LS_QUEUE = 'wh_queue_v1';
  const LS_GURU = 'wh_guru_list_v1';
  const LS_GEOCACHE = 'wh_geo_cache_v1';
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));

  function toast(msg, type='info', timeout=3200){
    const toasts = document.getElementById('toasts');
    if (!toasts) return console.log('TOAST:', msg);
    const el = document.createElement('div');
    el.className = 'px-4 py-2 rounded shadow flex items-center gap-3 text-sm';
    el.style.minWidth='220px';
    if (type==='ok') el.classList.add('bg-emerald-100','text-emerald-800');
    else if (type==='err') el.classList.add('bg-rose-100','text-rose-800');
    else el.classList.add('bg-slate-100','text-slate-800');
    el.textContent = msg;
    toasts.appendChild(el);
    setTimeout(()=>{ el.style.transition='opacity .25s'; el.style.opacity='0'; setTimeout(()=>el.remove(),300); }, timeout);
  }

  function loadAtt(){ try { return JSON.parse(localStorage.getItem(LS_ATT)||'[]'); } catch(e){ return []; } }
  function saveAtt(arr){ try { localStorage.setItem(LS_ATT, JSON.stringify(arr)); } catch(e){} }
  function loadGuru(){ try { return JSON.parse(localStorage.getItem(LS_GURU)||'[]'); } catch(e){ return []; } }

  // ---- GEO (Nominatim reverse geocode) ----
  function readGeoCache(){ try { return JSON.parse(localStorage.getItem(LS_GEOCACHE)||'{}'); } catch(e){ return {}; } }
  function writeGeoCache(o){ try { localStorage.setItem(LS_GEOCACHE, JSON.stringify(o)); } catch(e){} }
  function coordKey(lat, lon){ return `${Number(lat).toFixed(4)},${Number(lon).toFixed(4)}`; }

  async function reverseGeocode(lat, lon){
    const cache = readGeoCache(); const key = coordKey(lat,lon);
    if (cache[key]) return cache[key];
    try {
      const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}`;
      const res = await fetch(url, { headers: { 'Accept':'application/json' }});
      if (!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json();
      cache[key] = data;
      writeGeoCache(cache);
      return data;
    } catch(err){
      console.warn('reverseGeocode error', err);
      return null;
    }
  }

  async function captureLocationAndFill(){
    if (!navigator.geolocation) { toast('Geolocation tidak tersedia', 'err'); return null; }
    const btn = $('#ambilLokasiBtn'); const prev = btn?btn.textContent:'';
    if (btn){ btn.disabled = true; btn.textContent = 'Mengambil...'; }
    try {
      const pos = await new Promise((res, rej) => navigator.geolocation.getCurrentPosition(res, rej, { enableHighAccuracy:true, timeout:15000 }));
      const lat = pos.coords.latitude, lon = pos.coords.longitude;
      const coordLabel = `Lat ${lat.toFixed(5)}, Lon ${lon.toFixed(5)}`;
      if ($('#lokasi')) $('#lokasi').value = coordLabel;
      if ($('#coords-small')) $('#coords-small').textContent = `Koordinat: ${lat.toFixed(5)}, ${lon.toFixed(5)}`;
      const geo = await reverseGeocode(lat, lon);
      if (geo && geo.display_name && $('#placeName') && !$('#placeName').value) {
        $('#placeName').value = geo.display_name; toast('Nama tempat diisi otomatis', 'ok', 1400);
      }
      return { lat, lon, coordLabel };
    } catch(err){
      toast('Gagal ambil lokasi: '+(err && err.message?err.message:err), 'err', 2400);
      return null;
    } finally { if (btn){ btn.disabled=false; btn.textContent = prev; } }
  }

  // wire lokasi button
  document.addEventListener('click', (e) => {
    if (e.target && e.target.id === 'ambilLokasiBtn') captureLocationAndFill();
  });

  // ---- Chart.js safe renderer ----
  let dashboardChart = null;
  function renderAttendanceChart(){
    try {
      const canvas = document.getElementById('chartDashboard');
      if (!canvas) return;
      // destroy existing via Chart API if present
      try {
        if (Chart && typeof Chart.getChart === 'function') {
          const existing = Chart.getChart(canvas) || Chart.getChart(canvas.id);
          if (existing) { existing.destroy(); dashboardChart = null; }
        }
      } catch(e){ /* ignore */ }
      if (dashboardChart && typeof dashboardChart.destroy === 'function') {
        try { dashboardChart.destroy(); } catch(e){ console.warn('dashboardChart.destroy failed', e); }
        dashboardChart = null;
      }

      const today = new Date().toISOString().slice(0,10);
      const rows = loadAtt().filter(x => (x.tanggal||'').slice(0,10) === today);
      const counts = { Hadir:0, Izin:0, Sakit:0, 'Dinas Luar':0 };
      rows.forEach(r => { if (counts.hasOwnProperty(r.status)) counts[r.status]++; });

      const labels = Object.keys(counts);
      const data = labels.map(k=>counts[k]);

      dashboardChart = new Chart(canvas.getContext('2d'), {
        type: 'bar',
        data: { labels, datasets: [{ label:'Jumlah', data, backgroundColor: undefined }] },
        options: { responsive:true, plugins:{ legend:{ display:false } } }
      });
    } catch(err){
      console.error('renderAttendanceChart error', err);
    }
  }

  // ---- Recent activity ----
  function refreshRecentActivity(){
    const container = document.getElementById('recent-activity');
    if (!container) return;
    const rows = loadAtt().slice().reverse().slice(0,12);
    container.innerHTML = '';
    if (!rows.length){ container.innerHTML = '<div class="text-slate-400">Belum ada aktivitas.</div>'; return; }
    rows.forEach(r => {
      const el = document.createElement('div');
      el.className = 'p-1 rounded border border-dashed border-slate-100 bg-white';
      el.textContent = `${r.namaGuru} ‚Äî ${r.status} ${r.jam? '('+r.jam+')' : ''}`;
      container.appendChild(el);
    });
    // update counters
    const today = new Date().toISOString().slice(0,10);
    const todays = loadAtt().filter(x=>x.tanggal===today);
    if ($('#totalHadir')) $('#totalHadir').textContent = String(todays.filter(x=>x.status==='Hadir').length || 0);
    if ($('#totalLain')) $('#totalLain').textContent = String(todays.filter(x=>['Izin','Sakit','Dinas Luar'].includes(x.status)).length || 0);
  }

  // ---- Queue (enqueue + flush) ----
  function readQueue(){ try { return JSON.parse(localStorage.getItem(LS_QUEUE)||'[]'); } catch(e){ return []; } }
  function writeQueue(q){ try { localStorage.setItem(LS_QUEUE, JSON.stringify(q)); setPendingCount(q.length); } catch(e){} }
  function enqueueOp(op){ const q = readQueue(); q.push(op); writeQueue(q); toast('Operasi disimpan antrian', 'info', 1600); }
  function setPendingCount(n){ const el = document.getElementById('pending-count'); if (!el) return; if (!n) { el.classList.add('hidden'); el.textContent=''; } else { el.classList.remove('hidden'); el.textContent = n + ' pending'; } }

  // robust flushQueue: skip guru ops if not admin, handle permission errors gracefully
  let flushing = false;
  async function flushQueue(){
    if (flushing) return;
    const q = readQueue();
    if (!q.length) { setPendingCount(0); return; }
    if (!navigator.onLine) return;
    flushing = true;
    // check admin
    const currentUser = (window.__WH_FIREBASE && window.__WH_FIREBASE.currentUser) || null;
    const isAdmin = currentUser ? !!currentUser.admin : (localStorage.getItem('wh_admin_logged')==='1');

    for (let i=0;i<q.length;i++){
      const op = q[0]; // always process head
      try {
        if (['guru_add','guru_update','guru_delete'].includes(op.type) && !isAdmin) {
          // skip guru ops for non-admins; keep them in queue
          console.warn('Skipping guru op (not admin):', op);
          // move to next op (but stop to avoid busy loop)
          break;
        }
        if (op.type === 'attendance') {
          if (!window.addAttendanceFirebase) throw new Error('Firebase unavailable');
          await window.addAttendanceFirebase(op.payload);
        } else if (op.type === 'guru_add') {
          if (!window.addGuruFirebase) throw new Error('Firebase unavailable');
          await window.addGuruFirebase(op.payload);
        } else if (op.type === 'guru_update') {
          if (!window.updateGuruFirebase) throw new Error('Firebase unavailable');
          await window.updateGuruFirebase(op.payload.id, op.payload.updates);
        } else if (op.type === 'guru_delete') {
          if (!window.deleteGuruFirebase) throw new Error('Firebase unavailable');
          await window.deleteGuruFirebase(op.payload.id);
        } else {
          // unknown op -> drop
        }
        // remove head op on success
        const cur = readQueue(); cur.shift(); writeQueue(cur);
      } catch(err){
        console.warn('flushQueue error on op', op, err);
        const msg = (err && err.code) ? err.code : (err && err.message) ? err.message : String(err);
        if (String(msg).toLowerCase().includes('permission')) {
          toast('Sinkron gagal: permission denied ‚Äî pastikan akun admin atau rules DB benar', 'err', 5000);
          break;
        }
        // other errors: abort and try later
        break;
      }
    }
    flushing = false;
  }

  // try flushing periodically when online
  setInterval(()=>{ if (navigator.onLine) flushQueue(); setPendingCount(readQueue().length); }, 15000);
  window.addEventListener('online', ()=>{ toast('Koneksi online ‚Äî mencoba sinkron', 'info'); flushQueue(); });
  window.addEventListener('offline', ()=>{ toast('Perangkat offline', 'err'); });

  // ---- Laporan pivot / export ----
  const STATUS_MAP = { 'Hadir':'H', 'Izin':'I', 'Sakit':'S', 'Dinas Luar':'D' };
  function statusToAbbr(s){ return STATUS_MAP[s] || (s?String(s).charAt(0).toUpperCase():''); }
  function daysInMonth(y,m){ return new Date(y,m,0).getDate(); }

  function getRowsForMonth(yyyymm){ if (!yyyymm) return []; return loadAtt().filter(r => (r.tanggal||'').slice(0,7) === yyyymm); }

  function buildPivot(rows, year, month){
    const gurus = loadGuru();
    const days = daysInMonth(year, month);
    const pivot = {};
    gurus.forEach(g => { pivot[g.id] = { id:g.id, nama:g.nama||'-', cells:{} }; for(let d=1; d<=days; d++) pivot[g.id].cells[String(d).padStart(2,'0')] = ''; });
    rows.forEach(r => {
      const day = (r.tanggal||'').slice(8,10);
      const gid = r.idGuru || ('unknown_'+(r.namaGuru||'').replace(/\s+/g,'_'));
      if (!pivot[gid]) { pivot[gid] = { id:gid, nama: r.namaGuru||'-', cells:{} }; for(let d=1; d<=days; d++) pivot[gid].cells[String(d).padStart(2,'0')] = ''; }
      const ab = statusToAbbr(r.status);
      const prev = pivot[gid].cells[day];
      if (!prev) pivot[gid].cells[day] = ab;
      else if (prev !== 'H' && ab === 'H') pivot[gid].cells[day] = 'H';
    });
    return Object.values(pivot).sort((a,b)=> (a.nama||'').localeCompare(b.nama||''));
  }

  function renderPivotTableForMonth(yyyymm){
    const head = document.getElementById('laporanPivotHead');
    const body = document.getElementById('laporanPivotBody');
    const summary = document.getElementById('laporan-summary') || document.getElementById('laporan-summary-legacy');
    if (!yyyymm){ if (head) head.innerHTML=''; if (body) body.innerHTML = '<tr><td colspan="32" class="text-center p-6 text-slate-500">Pilih bulan untuk menampilkan data.</td></tr>'; if (summary) summary.textContent=''; return; }
    const [yStr,mStr] = yyyymm.split('-'); const y = Number(yStr), m = Number(mStr);
    const days = daysInMonth(y,m);
    let th = '<tr><th class="p-2 border text-left">Nama Guru</th>';
    for (let d=1; d<=days; d++) th += `<th class="p-2 border text-center">${d}</th>`;
    th += '</tr>'; if (head) head.innerHTML = th;
    const rows = getRowsForMonth(yyyymm);
    const pivot = buildPivot(rows, y, m);
    if (!pivot.length){ if (body) body.innerHTML = `<tr><td colspan="${days+1}" class="text-center p-6 text-slate-500">Tidak ada data untuk bulan ini.</td></tr>`; if (summary) summary.textContent='Tidak ada data.'; return; }
    if (body) body.innerHTML = pivot.map(r => {
      let cells = `<td class="p-2 border">${escapeHtml(r.nama||'-')}</td>`;
      for (let d=1; d<=days; d++){
        const k = String(d).padStart(2,'0'); const v = r.cells[k] || '';
        let cls = 'text-center p-1';
        if (v==='H') cls += ' text-green-700'; else if (v==='I') cls += ' text-amber-700'; else if (v==='S') cls += ' text-rose-600'; else if (v==='D') cls += ' text-sky-600';
        cells += `<td class="p-2 border ${cls}">${v || '-'}</td>`;
      }
      return `<tr>${cells}</tr>`;
    }).join('');
    if (summary) {
      const totalEntries = rows.length;
      const hadir = rows.filter(r=>r.status==='Hadir').length;
      summary.innerHTML = `<strong>Total entri:</strong> ${totalEntries} &middot; <strong>Hadir:</strong> ${hadir} &middot; <strong>% Kehadiran:</strong> ${ (totalEntries?Math.round(hadir/totalEntries*100):0) }%`;
    }
  }

  // tombol Tampilkan laporan
  document.getElementById('tampilkanLaporanBtn')?.addEventListener('click', ()=> {
    const val = document.getElementById('bulan')?.value;
    if (!val) return toast('Pilih bulan terlebih dahulu','err');
    renderPivotTableForMonth(val);
  });

  // export excel
  document.getElementById('exportLaporanBtn')?.addEventListener('click', ()=> {
    const val = document.getElementById('bulan')?.value;
    if (!val) return toast('Pilih bulan terlebih dahulu','err');
    const [y,m] = val.split('-').map(Number); const days = daysInMonth(y,m);
    const rows = getRowsForMonth(val); const pivot = buildPivot(rows,y,m);
    if (!pivot.length) return toast('Tidak ada data untuk diexport','err');
    const header = ['Nama Guru']; for (let d=1; d<=days; d++) header.push(String(d));
    const aoa = [header];
    pivot.forEach(r => {
      const row = [ r.nama || '' ];
      for (let d=1; d<=days; d++) row.push(r.cells[String(d).padStart(2,'0')] || '');
      aoa.push(row);
    });
    try {
      const ws = XLSX.utils.aoa_to_sheet(aoa);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, `Laporan-${val}`);
      XLSX.writeFile(wb, `laporan-pivot-${val}.xlsx`);
      toast('Export Excel selesai', 'ok');
    } catch(err){ console.error('export err', err); toast('Export gagal','err'); }
  });

  // initial render
  renderAttendanceChart();
  refreshRecentActivity();
  setTimeout(()=> { setPendingCount(readQueue().length); }, 300);

  // expose for debug
  window.__WH_REPORT = { renderAttendanceChart, refreshRecentActivity, captureLocationAndFill, renderPivotTableForMonth, enqueueOp, flushQueue };

})();
</script>
<!-- PART 6: Firebase wiring loader + runtime event wiring -->
<script>
(function(){
  const APP_FIREBASE_PATH = 'app.firebase.js';

  function loadScript(src, cb){
    const s = document.createElement('script');
    s.src = src;
    s.async = true;
    s.onload = () => cb && cb(null);
    s.onerror = (e) => cb && cb(new Error('Failed to load ' + src));
    document.head.appendChild(s);
  }

  function afterFirebaseReady(){
    // initial sync if available
    if (window.syncFromFirebase) {
      window.syncFromFirebase().then(res => {
        console.log('Initial syncFromFirebase OK', res);
      }).catch(err => console.warn('Initial sync failed', err));
    }

    // when gurus updated -> update UI caches
    window.addEventListener('gurus-updated', (ev) => {
      try {
        const arr = ev.detail || [];
        if (Array.isArray(arr)) {
          localStorage.setItem('wh_guru_list_v1', JSON.stringify(arr));
        }
      } catch(e){}
      // render (UI module listens too)
    });

    // when attendances updated -> update local cache and UI
    window.addEventListener('attendances-updated', (ev) => {
      try {
        const arr = ev.detail || [];
        if (Array.isArray(arr)) localStorage.setItem('wh_att_list_v1', JSON.stringify(arr));
      } catch(e){}
      // call report UI
      try { window.__WH_REPORT && window.__WH_REPORT.renderAttendanceChart(); window.__WH_REPORT && window.__WH_REPORT.refreshRecentActivity(); } catch(e){}
    });

    // auth-changed -> reflect admin UI
    window.addEventListener('auth-changed', (ev) => {
      const user = ev.detail;
      console.log('auth-changed', user);
      if (!user) {
        // signed out
        document.getElementById('admin-badge')?.classList?.add('hidden');
        document.getElementById('btn-admin-logout')?.classList?.add('hidden');
        document.getElementById('btn-open-admin')?.classList?.remove('hidden');
        localStorage.removeItem('wh_admin_logged');
        document.getElementById('admin-controls')?.remove();
        return;
      }
      // signed in
      if (user.admin) {
        localStorage.setItem('wh_admin_logged','1');
        document.getElementById('admin-badge')?.classList?.remove('hidden');
        document.getElementById('btn-admin-logout')?.classList?.remove('hidden');
        document.getElementById('btn-open-admin')?.classList?.add('hidden');
        // inject controls if missing
        if (!document.getElementById('admin-controls')) {
          const ph = document.getElementById('admin-controls-placeholder');
          if (ph) {
            const wrap = document.createElement('div');
            wrap.id = 'admin-controls';
            wrap.className = 'flex gap-2 items-center';
            wrap.innerHTML = `<button id="btn-add-guru-admin" class="bg-emerald-600 text-white px-3 py-1 rounded text-sm">Tambah Guru</button>
                              <button id="btn-sync-local" class="bg-slate-100 px-3 py-1 rounded text-sm">Sinkron</button>`;
            ph.appendChild(wrap);
            // wire add/sync (duplicate-safe)
            document.getElementById('btn-add-guru-admin')?.addEventListener('click', ()=> {
              document.getElementById('guru-modal-title').textContent='Tambah Guru';
              document.getElementById('guru-nip').value=''; document.getElementById('guru-nama-input').value=''; document.getElementById('guru-jabatan-input').value='';
              document.getElementById('guru-save').dataset.editId=''; document.getElementById('guru-modal').classList.remove('hidden');
            });
            document.getElementById('btn-sync-local')?.addEventListener('click', async ()=> {
              if (window.syncFromFirebase) { try { await window.syncFromFirebase(); alert('Sinkron selesai'); } catch(e){ alert('Sinkron gagal: '+(e.message||e)); } }
            });
          }
        }
      } else {
        // signed in but not admin
        localStorage.removeItem('wh_admin_logged');
        document.getElementById('admin-badge')?.classList?.add('hidden');
      }
    });

    // helpful check in console
    window.__WH_FIREBASE_CHECK = async function(){
      try {
        if (!window.__WH_FIREBASE) return { ok:false, reason:'no app.firebase.js' };
        const dbURL = (firebase && firebase.app && firebase.app().options && firebase.app().options.databaseURL) || null;
        await firebase.database().ref('/.info/connected').once('value');
        return { ok:true, databaseURL: dbURL };
      } catch(err){ return { ok:false, reason: err.message || String(err) }; }
    };
  } // afterFirebaseReady

  // Load app.firebase.js (if not already)
  if (!window.__WH_FIREBASE || !window.addGuruFirebase) {
    loadScript(APP_FIREBASE_PATH, (err) => {
      if (err) {
        console.error('app.firebase.js gagal dimuat:', err);
        document.dispatchEvent(new CustomEvent('app-firebase-load-failed', { detail: err.message }));
        return;
      }
      console.log('app.firebase.js loaded');
      try { afterFirebaseReady(); } catch(e){ console.warn(e); }
    });
  } else {
    afterFirebaseReady();
  }

})();
</script>
<!-- PART 7: Status-button FIX -->
<script>
// =======================================================
//  FIX STATUS BUTTON (ROBUST, ANTI ERROR, PASTI BISA DIKLIK)
// =======================================================
(function(){
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));

  // store selected status globally
  window.__WH_selectedStatus = window.__WH_selectedStatus || "";

  function setStatusValue(val){
    window.__WH_selectedStatus = val || "";
    const sel = document.getElementById("statusKehadiran");
    if (sel) sel.value = val || "";
  }
  function clearStatusButtons(){
    $$(".status-btn").forEach(btn=>{
      btn.classList.remove("bg-rose-100","ring-4","ring-rose-300");
    });
  }
  function activateButton(btn){
    clearStatusButtons();
    btn.classList.add("bg-rose-100","ring-4","ring-rose-300");
  }
  function handleStatusClick(btn){
    const val = btn.dataset.status;
    if (!val) return;
    if (window.__WH_selectedStatus === val){
      // toggle off
      clearStatusButtons();
      setStatusValue("");
      return;
    }
    activateButton(btn);
    setStatusValue(val);
  }

  // Delegation for ALL future buttons, guaranteed working
  document.addEventListener("click", (e)=>{
    const btn = e.target.closest && e.target.closest(".status-btn");
    if (!btn) return;
    e.preventDefault();
    e.stopPropagation();
    handleStatusClick(btn);
  });

  // keyboard support
  document.addEventListener("keydown", (e)=>{
    const el = e.target;
    if (!el || !el.classList) return;
    if (!el.classList.contains("status-btn")) return;
    if (e.key === " " || e.key === "Enter"){
      e.preventDefault();
      handleStatusClick(el);
    }
  });

  // expose debug
  window.__WH_getStatus = () => window.__WH_selectedStatus;

})();
</script>

<!-- END OF ALL SCRIPTS -->
</body>
</html>
