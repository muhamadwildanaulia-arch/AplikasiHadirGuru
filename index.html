<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WebsiteHadir ‚Äî SDN Muhara (Full Online + Auth)</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js & XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <!-- Firebase compat (APP, DB, AUTH) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>

  <link rel="icon" type="image/png" href="Logo.png">

  <style>
    .sidebar { background: linear-gradient(180deg,#7f1d1d, #b91c1c); }
    .card-smooth { background: linear-gradient(180deg,#fff,#f8fafc); border-radius:12px; box-shadow:0 6px 22px rgba(15,23,42,0.06); }
    #toasts { position: fixed; right: 20px; bottom: 20px; z-index: 60; display: flex; flex-direction: column; gap: 8px; }
  </style>
</head>

<body class="antialiased bg-slate-50 text-slate-800">
  <div class="min-h-screen flex">
    
    <!-- SIDEBAR -->
    <aside class="sidebar hidden md:flex md:flex-col md:w-64 md:py-6 md:px-4">
      <div class="flex items-center gap-3 mb-6">
        <img src="Logo.png" class="h-12 w-12 rounded-md shadow-sm bg-white p-1" />
        <div>
          <h1 class="text-white font-bold">SDN Muhara</h1>
          <div class="text-sm text-red-200 italic">WebsiteHadir ‚Ä¢ Dashboard</div>
        </div>
      </div>

      <nav class="mt-6 flex-1">
        <ul class="space-y-1">
          <li><button data-page="kehadiran" class="nav-item w-full text-left px-3 py-2 rounded-md hover:bg-white/10">üì• Isi Kehadiran</button></li>
          <li><button data-page="dashboard" class="nav-item w-full text-left px-3 py-2 rounded-md hover:bg-white/10">üìä Dashboard</button></li>
          <li><button data-page="guru" class="nav-item w-full text-left px-3 py-2 rounded-md hover:bg-white/10">üë©‚Äçüè´ Data Guru</button></li>
          <li><button data-page="laporan" class="nav-item w-full text-left px-3 py-2 rounded-md hover:bg-white/10">üìÖ Laporan Bulanan</button></li>
        </ul>
      </nav>

      <div class="mt-auto text-sm text-red-100 px-3">Versi Online ‚Ä¢ 2025</div>
    </aside>

    <!-- MOBILE NAV -->
    <div class="md:hidden fixed bottom-3 left-1/2 -translate-x-1/2 bg-white/90 shadow-lg rounded-full px-3 py-1 z-40 flex gap-2">
      <button data-page="kehadiran" class="px-3 py-2 rounded-full text-sm">üì•</button>
      <button data-page="dashboard" class="px-3 py-2 rounded-full text-sm">üìä</button>
      <button data-page="guru" class="px-3 py-2 rounded-full text-sm">üë©‚Äçüè´</button>
      <button data-page="laporan" class="px-3 py-2 rounded-full text-sm">üìÖ</button>
    </div>

    <!-- MAIN CONTENT -->
    <div class="flex-1 min-w-0">

      <!-- TOPBAR -->
      <header class="flex items-center justify-between bg-white/80 backdrop-blur sticky top-0 z-30 border-b border-slate-200 px-4 py-3">
        <div class="flex items-center gap-4">
          <button id="btn-toggle-sidebar" class="md:hidden p-2 rounded bg-white/60">‚ò∞</button>
          <div>
            <div class="text-sm text-slate-500" id="current-date-top"></div>
            <div class="text-lg font-semibold">Dashboard Kehadiran</div>
          </div>
        </div>

        <div class="flex items-center gap-4">
          <div id="clock-small" class="text-sm text-slate-600"></div>

          <button id="btn-open-admin" class="text-sm px-3 py-1 rounded bg-rose-600 text-white">Login Admin</button>
          <button id="btn-admin-logout" class="text-sm text-slate-600 underline hidden">Logout</button>
        </div>
      </header>

      <main class="p-6">
        <div class="max-w-7xl mx-auto">

          <!-- DASHBOARD CARDS -->
          <div id="page-dashboard" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 hidden">
            <div class="card-smooth p-5">
              <div class="text-sm text-slate-500">Total Guru</div>
              <div id="totalGuru" class="text-3xl font-bold mt-2">0</div>
            </div>
            <div class="card-smooth p-5">
              <div class="text-sm text-slate-500">Hadir Hari Ini</div>
              <div id="totalHadir" class="text-3xl font-bold text-green-600 mt-2">0</div>
            </div>
            <div class="card-smooth p-5">
              <div class="text-sm text-slate-500">Izin / Sakit / Dinas</div>
              <div id="totalLain" class="text-3xl font-bold text-amber-600 mt-2">0</div>
            </div>
          </div>

          <!-- FORM KEHADIRAN -->
          <section id="page-kehadiran" class="">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

              <!-- FORM -->
              <div class="card-smooth p-6">
                <h2 class="text-xl font-semibold mb-2">üì• Isi Kehadiran</h2>
                <p class="text-sm text-slate-500 mb-4">Pilih nama guru, pilih status, lokasi otomatis terisi.</p>

                <div class="space-y-4">
                  <div>
                    <label class="block text-sm text-slate-700 mb-1">Nama Guru</label>
                    <select id="namaGuru" class="w-full border rounded p-2"></select>
                  </div>

                  <div>
                    <label class="block text-sm text-slate-700 mb-1">Status Kehadiran</label>
                    <div class="grid grid-cols-2 gap-3">
                      <button class="status-btn p-3 border rounded text-center" data-status="Hadir">Hadir</button>
                      <button class="status-btn p-3 border rounded text-center" data-status="Izin">Izin</button>
                      <button class="status-btn p-3 border rounded text-center" data-status="Sakit">Sakit</button>
                      <button class="status-btn p-3 border rounded text-center" data-status="Dinas Luar">Dinas Luar</button>
                    </div>
                  </div>

                  <div>
                    <label class="block text-sm text-slate-700 mb-1">Nama Tempat (otomatis)</label>
                    <input id="placeName" class="w-full border rounded p-2" placeholder="Mengambil lokasi..." />

                    <label class="block text-sm text-slate-700 mt-2 mb-1">Lokasi Koordinat</label>
                    <input id="lokasi" readonly class="w-full border rounded p-2 bg-slate-50" placeholder="Menunggu..." />
                    <div id="coords-small" class="text-xs text-slate-400 mt-1">Koordinat: ‚Äî</div>

                    <button id="ambilLokasiBtn" class="mt-3 bg-sky-600 text-white px-3 py-2 rounded">üìç Ambil Lokasi</button>
                  </div>

                  <div class="flex gap-3 items-center">
                    <button id="kirimKehadiranBtn" class="bg-rose-600 hover:bg-rose-700 text-white px-4 py-2 rounded">üöÄ Kirim Kehadiran</button>
                    <div id="kehadiran-status" class="text-sm text-slate-500">‚Äî</div>
                  </div>
                </div>
              </div>

              <!-- GRAFIK + AKTIVITAS -->
              <div class="card-smooth p-6">
                <h3 class="font-semibold">Grafik Kehadiran Hari Ini</h3>
                <canvas id="chartDashboard" height="180" class="mt-4"></canvas>

                <div class="mt-6">
                  <h4 class="font-medium text-slate-700 mb-2">Aktivitas Terbaru</h4>
                  <div id="recent-activity" class="space-y-1 text-slate-700 text-sm">
                    <p class="text-slate-400">Menunggu data...</p>
                  </div>
                </div>
              </div>

            </div>
          </section>

          <!-- DATA GURU -->
          <section id="page-guru" class="hidden">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-xl font-semibold">üë©‚Äçüè´ Daftar Guru</h2>
              <div id="admin-controls-placeholder"></div>
            </div>

            <div class="bg-white rounded-xl shadow p-4 overflow-auto">
              <table class="min-w-full text-sm">
                <thead class="bg-rose-50 text-rose-700 font-semibold">
                  <tr>
                    <th class="border p-2 text-left">NIP</th>
                    <th class="border p-2 text-left">Nama Guru</th>
                    <th class="border p-2 text-left">Jabatan</th>
                    <th class="border p-2 text-left">Status</th>
                    <th class="border p-2 text-left">Aksi</th>
                  </tr>
                </thead>
                <tbody id="guruTableBody">
                  <tr><td colspan="5" class="text-center p-6 text-slate-500">Memuat data...</td></tr>
                </tbody>
              </table>
            </div>
          </section>

          <!-- LAPORAN -->
          <section id="page-laporan" class="hidden">
            <div class="flex flex-wrap gap-3 items-center mb-4">
              <input type="month" id="bulan" class="border rounded p-2" />
              <button id="tampilkanLaporanBtn" class="bg-sky-600 text-white px-4 py-2 rounded">Tampilkan</button>
              <button id="exportLaporanBtn" class="bg-emerald-600 text-white px-4 py-2 rounded">üì• Excel</button>
            </div>

            <div class="bg-white rounded-xl shadow p-4 overflow-auto mb-4">
              <table class="min-w-full text-sm">
                <thead id="laporanPivotHead" class="bg-rose-50 text-rose-700 font-semibold"></thead>
                <tbody id="laporanPivotBody">
                  <tr><td class="text-center p-6 text-slate-500">Pilih bulan terlebih dahulu.</td></tr>
                </tbody>
              </table>
            </div>

            <div id="laporan-summary" class="bg-rose-50 rounded-xl p-4 text-slate-700"></div>
          </section>

        </div>
      </main>

    </div>
  </div>


  <!-- TOAST AREA -->
  <div id="toasts"></div>

  <!-- ADMIN LOGIN MODAL -->
  <div id="admin-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40">
    <div class="bg-white rounded-xl shadow-lg p-6 w-96">
      <h3 class="text-lg font-semibold mb-2">Login Admin</h3>
      <input id="admin-username" class="border p-2 rounded w-full mb-2" placeholder="Email admin" />
      <input id="admin-password" type="password" class="border p-2 rounded w-full mb-2" placeholder="Password admin" />
      <div class="flex justify-end gap-2">
        <button id="admin-cancel" class="px-3 py-1 rounded bg-slate-100">Batal</button>
        <button id="admin-submit" class="px-3 py-1 rounded bg-rose-600 text-white">Login</button>
      </div>
      <p id="admin-msg" class="text-sm text-red-600"></p>
    </div>
  </div>

  <!-- GURU CRUD MODAL -->
  <div id="guru-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40">
    <div class="bg-white rounded-xl shadow-lg p-6 w-96">
      <h3 id="guru-modal-title" class="text-lg font-semibold mb-2">Tambah Guru</h3>
      <input id="guru-nip" class="border p-2 rounded w-full mb-2" placeholder="NIP (opsional)" />
      <input id="guru-nama-input" class="border p-2 rounded w-full mb-2" placeholder="Nama lengkap" />
      <input id="guru-jabatan-input" class="border p-2 rounded w-full mb-2" placeholder="Jabatan/Mapel" />
      <div class="flex justify-end gap-2">
        <button id="guru-cancel" class="px-3 py-1 rounded bg-slate-100">Batal</button>
        <button id="guru-save" class="px-3 py-1 rounded bg-rose-600 text-white">Simpan</button>
      </div>
    </div>
  </div>

  <footer class="fixed left-0 right-0 bottom-0 md:static md:mt-8 text-center text-slate-500 text-sm p-3 md:p-6">
    D.A.N √ó GPT-5 | Full Online Version 2025
  </footer>
<script>
(function(){
  // --- Helpers ---
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  function toast(msg, type='info', timeout=3600){
    const toasts = document.getElementById('toasts');
    if (!toasts) return console.log('TOAST:', msg);
    const el = document.createElement('div');
    el.className = 'px-4 py-2 rounded shadow flex items-center gap-3 text-sm';
    el.style.minWidth = '220px';
    if (type==='ok') el.classList.add('bg-emerald-100','text-emerald-800');
    else if (type==='err') el.classList.add('bg-rose-100','text-rose-800');
    else el.classList.add('bg-slate-100','text-slate-800');
    el.textContent = msg;
    toasts.appendChild(el);
    setTimeout(()=>{ el.style.transition='opacity .25s'; el.style.opacity='0'; setTimeout(()=>el.remove(),300); }, timeout);
  }

  function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"'`]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;","`":"&#96;"}[c])); }

  // --- UI state elements ---
  const netDot = nullSafe('#net-dot');
  const netStatus = nullSafe('#net-status');
  const pendingBadge = nullSafe('#pending-count');
  const lastSyncEl = nullSafe('#last-sync');
  const coordsSmall = nullSafe('#coords-small');

  function nullSafe(sel){ return document.querySelector(sel) || { classList: { add(){}, remove(){} }, textContent:'', style: {} }; }

  // --- LocalStorage keys ---
  const LS_GURU = 'wh_demo_guru_v1';
  const LS_ATT = 'wh_demo_att_v1';
  const LS_QUEUE = 'wh_queue_v1';
  const LS_GEOCACHE = 'wh_geo_cache_v1';

  // --- Queue helpers ---
  function readQueue(){ try { return JSON.parse(localStorage.getItem(LS_QUEUE)||'[]'); } catch(e){ return []; } }
  function writeQueue(q){ localStorage.setItem(LS_QUEUE, JSON.stringify(q)); setPendingCount(q.length); }
  function enqueueOp(op){ // op: {type, payload, ts}
    const q = readQueue(); q.push(op); writeQueue(q); toast('Operasi dimasukkan antrian', 'info', 2000);
  }
  function clearQueue(){ localStorage.removeItem(LS_QUEUE); setPendingCount(0); }
  function setPendingCount(n){ const el = document.querySelector('#pending-count'); if (!el) return; if (!n || n<=0){ el.classList.add('hidden'); el.textContent=''; } else { el.classList.remove('hidden'); el.textContent = n + ' pending'; } }
  function setLastSync(ts){ const el = document.querySelector('#last-sync'); if (!el) return; if (!ts){ el.classList.add('hidden'); el.textContent=''; } else { el.classList.remove('hidden'); el.textContent = 'Last sync: ' + new Date(ts).toLocaleString('id-ID'); } }

  // --- Network indicator ---
  function updateNetworkUI(){
    const dot = document.querySelector('#net-dot');
    const txt = document.querySelector('#net-status');
    if (!dot || !txt) return;
    if (navigator.onLine){ dot.classList.remove('bg-rose-600'); dot.classList.add('bg-green-500'); txt.textContent='Online'; }
    else { dot.classList.remove('bg-green-500'); dot.classList.add('bg-rose-600'); txt.textContent='Offline'; }
  }
  window.addEventListener('online', ()=> { updateNetworkUI(); flushQueue(); toast('Koneksi kembali ‚Äî mencoba sinkronisasi', 'info'); });
  window.addEventListener('offline', ()=> { updateNetworkUI(); toast('Perangkat offline', 'err'); });
  updateNetworkUI();

  // --- read/write caches ---
  function loadGuruList(){ try { return JSON.parse(localStorage.getItem(LS_GURU)||'[]'); } catch(e){ return []; } }
  function saveGuruList(list){ localStorage.setItem(LS_GURU, JSON.stringify(list)); }
  function loadAtt(){ try { return JSON.parse(localStorage.getItem(LS_ATT)||'[]'); } catch(e){ return []; } }
  function saveAtt(list){ localStorage.setItem(LS_ATT, JSON.stringify(list)); }

  // --- Render Guru Table & Select ---
  function renderGuruTable(){
    const tb = $('#guruTableBody');
    const list = loadGuruList();
    if (!tb) return;
    if (!list.length){ tb.innerHTML = '<tr><td colspan="5" class="text-center p-6 text-slate-500">Belum ada guru terdaftar.</td></tr>'; populateNamaSelect([]); return; }
    tb.innerHTML = '';
    list.forEach(g => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="border p-2">${escapeHtml(g.nip||'')}</td>
        <td class="border p-2">${escapeHtml(g.nama||'')}</td>
        <td class="border p-2">${escapeHtml(g.jabatan||'')}</td>
        <td class="border p-2">${escapeHtml(g.status||'Aktif')}</td>
        <td class="border p-2">
          <button class="btn-edit px-2 py-1 rounded bg-yellow-400 text-sm mr-2" data-id="${g.id}">Edit</button>
          <button class="btn-del px-2 py-1 rounded bg-rose-600 text-white text-sm" data-id="${g.id}">Hapus</button>
        </td>
      `;
      tb.appendChild(tr);
    });
    // attach handlers
    $$('.btn-edit').forEach(b => b.onclick = (e)=> {
      const id = e.currentTarget.dataset.id;
      const g = loadGuruList().find(x=>x.id===id);
      if (!g) return toast('Data guru tidak ditemukan','err');
      $('#guru-modal-title').textContent = 'Edit Guru';
      $('#guru-nip').value = g.nip || '';
      $('#guru-nama-input').value = g.nama || '';
      $('#guru-jabatan-input').value = g.jabatan || '';
      $('#guru-save').dataset.editId = g.id;
      $('#guru-modal').classList.remove('hidden');
    });
    $$('.btn-del').forEach(b => b.onclick = async (e)=> {
      const id = e.currentTarget.dataset.id;
      if (!confirm('Hapus guru ini?')) return;
      try {
        if (window.deleteGuruFirebase) {
          // if user not admin, firebase will reject ‚Äî catch and enqueue
          await window.deleteGuruFirebase(id);
          toast('Permintaan hapus dikirim ke server', 'ok');
        } else {
          const list = loadGuruList().filter(x=>x.id!==id); saveGuruList(list); renderGuruTable(); populateNamaSelect();
          toast('Guru dihapus (lokal)', 'ok');
        }
      } catch(err){
        console.error('deleteGuru err', err);
        enqueueOp({ type:'guru_delete', payload:{ id }, ts: Date.now() });
        toast('Gagal hapus dari server ‚Äî masuk antrian', 'err', 3000);
      }
    });
    $('#totalGuru') && ($('#totalGuru').textContent = String(list.length));
  }

  function populateNamaSelect(listOverride){
    const sel = $('#namaGuru'); if (!sel) return;
    const list = (listOverride && Array.isArray(listOverride)) ? listOverride : loadGuruList();
    sel.innerHTML = '<option value="">-- Pilih Guru --</option>';
    list.forEach(g => {
      const opt = document.createElement('option');
      opt.value = `${g.id}||${g.nama||''}`;
      opt.textContent = `${g.nama || ''}${g.jabatan ? ' ‚Äî ' + g.jabatan : ''}`;
      sel.appendChild(opt);
    });
  }

  // --- Recent Activity & Chart ---
  function refreshRecentActivity(){
    const container = $('#recent-activity'); if (!container) return;
    const rows = loadAtt().slice().reverse().slice(0,12);
    container.innerHTML = '';
    if (!rows.length) { container.innerHTML = '<div class="text-slate-400">Belum ada aktivitas.</div>'; return; }
    rows.forEach(r => {
      const el = document.createElement('div'); el.className = 'p-1 rounded border border-dashed border-slate-100 bg-white';
      el.textContent = `${r.namaGuru} ‚Äî ${r.status} (${r.jam || ''})`;
      container.appendChild(el);
    });
    const today = new Date().toISOString().slice(0,10);
    const todays = loadAtt().filter(x=>x.tanggal===today);
    $('#totalHadir') && ($('#totalHadir').textContent = String(todays.filter(x=>x.status==='Hadir').length || 0));
    $('#totalLain') && ($('#totalLain').textContent = String(todays.filter(x=>['Izin','Sakit','Dinas Luar'].includes(x.status)).length || 0));
  }

  let chart = null;
  function renderChart(){
    const ctxEl = document.getElementById('chartDashboard');
    if (!ctxEl) return;
    const ctx = ctxEl.getContext('2d');
    const today = new Date().toISOString().slice(0,10);
    const rows = loadAtt().filter(x=>x.tanggal===today);
    const counts = { Hadir:0, Izin:0, Sakit:0, 'Dinas Luar':0 };
    rows.forEach(r => { if (counts[r.status]!==undefined) counts[r.status]++; });
    const labels = Object.keys(counts);
    const data = labels.map(l => counts[l]);
    if (chart) chart.destroy();
    chart = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label:'Jumlah', data }] },
      options: { responsive:true, plugins:{ legend:{ display:false } } }
    });
  }

  // --- Geolocation + Reverse Geocode (Nominatim) with cache ---
  function readGeoCache(){ try { return JSON.parse(localStorage.getItem(LS_GEOCACHE)||'{}'); } catch(e){ return {}; } }
  function writeGeoCache(o){ try { localStorage.setItem(LS_GEOCACHE, JSON.stringify(o)); } catch(e){} }
  function cacheKeyForCoords(lat, lon){ return `${Number(lat).toFixed(4)},${Number(lon).toFixed(4)}`; }

  async function reverseGeocode(lat, lon){
    const cache = readGeoCache(); const key = cacheKeyForCoords(lat, lon);
    if (cache[key]) return cache[key];
    try {
      const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}`, { headers: { 'Accept':'application/json' }});
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();
      cache[key] = data; writeGeoCache(cache);
      return data;
    } catch(err){
      console.warn('reverseGeocode error', err);
      return null;
    }
  }

  async function captureLocationAndFill(){
    if (!navigator.geolocation) { toast('Geolocation tidak tersedia pada perangkat ini', 'err'); return null; }
    const btn = $('#ambilLokasiBtn');
    const orig = btn ? btn.textContent : null;
    if (btn) { btn.disabled = true; btn.textContent = 'Mengambil...'; }
    try {
      const pos = await new Promise((res, rej) => navigator.geolocation.getCurrentPosition(res, rej, { enableHighAccuracy:true, timeout:12000 }));
      const { latitude, longitude } = pos.coords;
      const coordLabel = `Lat ${latitude.toFixed(5)}, Lon ${longitude.toFixed(5)}`;
      $('#lokasi').value = coordLabel;
      coordsSmall.textContent = `Koordinat: ${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
      const geo = await reverseGeocode(latitude, longitude);
      if (geo && geo.display_name) {
        if (!$('#placeName').value) { $('#placeName').value = geo.display_name; toast('Nama tempat diisi otomatis', 'ok', 1600); }
      } else {
        toast('Lokasi terdeteksi ‚Äî nama tempat tidak ditemukan', 'info', 1600);
      }
      return { latitude, longitude, coordLabel };
    } catch(err){
      toast('Gagal ambil lokasi: '+(err.message||err), 'err', 2600);
      return null;
    } finally {
      if (btn) { btn.disabled=false; btn.textContent = orig; }
    }
  }

  $('#ambilLokasiBtn') && $('#ambilLokasiBtn').addEventListener('click', ()=> captureLocationAndFill());

  // --- Status buttons (for alternate UI) ---
  let selectedStatus = '';
  $$('.status-btn').forEach(b=>{
    b.addEventListener('click', ()=>{
      $$('.status-btn').forEach(x=>x.classList.remove('bg-rose-100','ring-4'));
      b.classList.add('bg-rose-100','ring-4');
      selectedStatus = b.dataset.status;
      // also set dropdown for compatibility
      const sel = $('#statusKehadiran'); if (sel) sel.value = selectedStatus;
    });
  });

  // Ensure dropdown exists (part earlier used buttons; if not present, create)
  if (!$('#statusKehadiran')){
    const select = document.createElement('select'); select.id='statusKehadiran'; select.className='hidden';
    select.innerHTML = '<option value="">--</option><option value="Hadir">Hadir</option><option value="Izin">Izin</option><option value="Sakit">Sakit</option><option value="Dinas Luar">Dinas Luar</option>';
    document.body.appendChild(select);
  }

  // --- Send attendance (try Firebase, else enqueue) ---
  $('#kirimKehadiranBtn') && $('#kirimKehadiranBtn').addEventListener('click', async ()=>{
    const sel = $('#namaGuru').value;
    if (!sel) return toast('Pilih nama guru terlebih dahulu','err');
    // status: either from selectedStatus (buttons) or dropdown
    const status = selectedStatus || ($('#statusKehadiran')&&$('#statusKehadiran').value) || '';
    if (!status) return toast('Pilih status kehadiran','err');
    const [id, name] = sel.split('||');
    const placeName = ($('#placeName').value||'').trim();
    const lokasiLabel = ($('#lokasi').value||'').trim();
    const jam = new Date().toLocaleTimeString('id-ID');
    const tanggal = new Date().toISOString().slice(0,10);
    const payload = { idGuru:id, namaGuru:name, status, placeName, lokasiLabel, jam, tanggal };

    const btn = $('#kirimKehadiranBtn'); const prevText = btn.textContent; btn.disabled=true; btn.textContent='Mengirim...';
    try {
      if (window.addAttendanceFirebase) {
        try {
          await window.addAttendanceFirebase(payload);
          toast('Kehadiran dikirim ke server', 'ok', 1500);
        } catch(err){
          console.warn('addAttendanceFirebase failed', err);
          enqueueOp({ type:'attendance', payload, ts: Date.now() });
          toast('Gagal kirim ‚Äî masuk antrian', 'err', 2400);
        }
      } else {
        enqueueOp({ type:'attendance', payload, ts: Date.now() });
        toast('Firebase belum tersedia ‚Äî masuk antrian', 'info', 2000);
      }
      // optimistic local update
      const arr = loadAtt(); arr.push(Object.assign({}, payload, { createdAt: Date.now() })); saveAtt(arr);
      refreshRecentActivity(); renderChart();
    } finally {
      btn.disabled=false; btn.textContent=prevText; $('#kehadiran-status').textContent='Terkirim';
      setTimeout(()=> $('#kehadiran-status').textContent='‚Äî', 1200);
      selectedStatus=''; $$('.status-btn').forEach(x=>x.classList.remove('bg-rose-100','ring-4'));
    }
  });

  // --- Queue flushing (process ops in order) ---
  let flushing = false;
  async function flushQueue(){
    if (flushing) return;
    const q = readQueue();
    if (!q.length) { setPendingCount(0); return; }
    if (!navigator.onLine) return;
    if (!window.addAttendanceFirebase && !window.addGuruFirebase) return;
    flushing = true;
    for (let i=0;i<q.length;i++){
      const op = q[i];
      try {
        if (op.type === 'attendance'){
          await window.addAttendanceFirebase(op.payload);
        } else if (op.type === 'guru_add'){
          await window.addGuruFirebase(op.payload);
        } else if (op.type === 'guru_update'){
          await window.updateGuruFirebase(op.payload.id, op.payload.updates);
        } else if (op.type === 'guru_delete'){
          await window.deleteGuruFirebase(op.payload.id);
        }
        // continue
      } catch(err){
        console.warn('flushQueue failed on op:', op, err);
        // stop trying now to avoid tight loop ‚Äî will retry later
        flushing = false;
        return;
      }
    }
    // all succeeded -> clear queue
    clearQueue();
    setLastSync(Date.now());
    toast('Antrian berhasil disinkronkan ke server', 'ok', 2000);
    flushing = false;
  }

  // attempt flush periodically
  setInterval(()=> { if (navigator.onLine) flushQueue(); setPendingCount(readQueue().length); }, 15000);

  // --- Laporan Pivot (H/I/S/D) ---
  const STATUS_ABBR = { 'Hadir':'H', 'Izin':'I', 'Sakit':'S', 'Dinas Luar':'D' };
  function statusToAbbr(s){ if (!s) return ''; return STATUS_ABBR[s] || s.charAt(0).toUpperCase(); }
  function daysInMonth(y,m){ return new Date(y,m,0).getDate(); }

  function getRowsForMonth(yyyymm){
    if (!yyyymm) return [];
    return loadAtt().filter(r => (r.tanggal||'').slice(0,7) === yyyymm);
  }

  function buildPivot(rows, year, month){
    const gurus = loadGuruList();
    const days = daysInMonth(year, month);
    const pivot = {};
    gurus.forEach(g => { pivot[g.id] = { id:g.id, nama:g.nama, cells:{} }; for(let d=1; d<=days; d++) pivot[g.id].cells[String(d).padStart(2,'0')] = ''; });
    rows.forEach(r => {
      const day = (r.tanggal||'').slice(8,10);
      const gid = r.idGuru || ('unknown_'+(r.namaGuru||'').replace(/\s+/g,'_'));
      if (!pivot[gid]) { pivot[gid] = { id: gid, nama: r.namaGuru || '‚Äî', cells:{} }; for(let d=1; d<=days; d++) pivot[gid].cells[String(d).padStart(2,'0')] = ''; }
      const ab = statusToAbbr(r.status);
      const prev = pivot[gid].cells[day];
      if (!prev) pivot[gid].cells[day] = ab;
      else if (prev !== 'H' && ab === 'H') pivot[gid].cells[day] = 'H';
    });
    return Object.values(pivot).sort((a,b)=> (a.nama||'').localeCompare(b.nama||''));
  }

  function renderPivotTableForMonth(yyyymm){
    const head = $('#laporanPivotHead'), body = $('#laporanPivotBody');
    if (!yyyymm) { if (head) head.innerHTML=''; if (body) body.innerHTML='<tr><td colspan="32" class="text-center p-6 text-slate-500">Pilih bulan untuk menampilkan data.</td></tr>'; return; }
    const [yStr, mStr] = yyyymm.split('-'); const y = Number(yStr), m = Number(mStr);
    const days = daysInMonth(y,m);
    let th = '<tr><th class="p-2 border text-left">Nama Guru</th>';
    for (let d=1; d<=days; d++) th += `<th class="p-2 border text-center">${d}</th>`;
    th += '</tr>'; if (head) head.innerHTML = th;

    const rows = getRowsForMonth(yyyymm); const pivot = buildPivot(rows, y, m);
    if (!pivot.length) { if (body) body.innerHTML = `<tr><td colspan="${days+1}" class="text-center p-6 text-slate-500">Tidak ada data untuk bulan ini.</td></tr>`; $('#laporan-summary').textContent = 'Tidak ada data.'; return; }
    if (body) body.innerHTML = pivot.map(r => {
      let cells = `<td class="p-2 border">${escapeHtml(r.nama||'‚Äî')}</td>`;
      for (let d=1; d<=days; d++){
        const k = String(d).padStart(2,'0'); const v = r.cells[k] || ''; let cls = 'text-center p-1';
        if (v==='H') cls += ' text-green-700'; else if (v==='I') cls += ' text-amber-700'; else if (v==='S') cls += ' text-rose-600'; else if (v==='D') cls += ' text-sky-600';
        cells += `<td class="p-2 border ${cls}">${v || '-'}</td>`;
      }
      return `<tr>${cells}</tr>`;
    }).join('');
    const totalEntries = rows.length, hadir = rows.filter(r=>r.status==='Hadir').length;
    $('#laporan-summary').innerHTML = `<strong>Total entri:</strong> ${totalEntries} &middot; <strong>Hadir:</strong> ${hadir} &middot; <strong>% Kehadiran:</strong> ${ (totalEntries?Math.round(hadir/totalEntries*100):0) }%`;
  }

  $('#tampilkanLaporanBtn') && $('#tampilkanLaporanBtn').addEventListener('click', ()=> {
    const val = $('#bulan').value; if (!val) return toast('Pilih bulan terlebih dahulu','err'); renderPivotTableForMonth(val);
  });

  // Exports
  $('#exportLaporanBtn') && $('#exportLaporanBtn').addEventListener('click', ()=> {
    const val = $('#bulan').value; if (!val) return toast('Pilih bulan terlebih dahulu','err');
    const [y,m] = val.split('-').map(Number); const days = daysInMonth(y,m);
    const rows = getRowsForMonth(val); const pivot = buildPivot(rows,y,m);
    if (!pivot.length) return toast('Tidak ada data untuk diexport','err');
    const header = ['Nama Guru']; for (let d=1; d<=days; d++) header.push(String(d));
    const aoa = [header];
    pivot.forEach(r => {
      const row = [ r.nama || '' ];
      for (let d=1; d<=days; d++) row.push(r.cells[String(d).padStart(2,'0')] || '');
      aoa.push(row);
    });
    const ws = XLSX.utils.aoa_to_sheet(aoa); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'LaporanPivot');
    XLSX.writeFile(wb, `laporan-pivot-${val}.xlsx`);
    toast('Export Excel selesai', 'ok');
  });

  // --- Firebase event listeners (UI reacts to app.firebase.js) ---
  window.addEventListener('gurus-updated', (ev) => {
    // app.firebase.js stores latest into localStorage; render from there
    renderGuruTable();
    populateNamaSelect(loadGuruList());
  });
  window.addEventListener('attendances-updated', (ev) => {
    refreshRecentActivity(); renderChart(); setLastSync(Date.now());
  });

  // --- Admin auth wiring (listen to auth-changed) ---
  window.addEventListener('auth-changed', (ev) => {
    const user = ev.detail;
    if (!user) {
      $('#btn-open-admin') && $('#btn-open-admin').classList.remove('hidden');
      $('#btn-admin-logout') && $('#btn-admin-logout').classList.add('hidden');
      document.getElementById('admin-controls')?.remove();
      toast('Tidak terautentikasi', 'info');
      return;
    }
    if (user.admin) {
      $('#btn-open-admin') && $('#btn-open-admin').classList.add('hidden');
      $('#btn-admin-logout') && $('#btn-admin-logout').classList.remove('hidden');
      // add admin controls if missing
      if (!document.getElementById('admin-controls')){
        const ph = document.getElementById('admin-controls-placeholder');
        if (ph){
          const wrap = document.createElement('div'); wrap.id = 'admin-controls'; wrap.className = 'flex gap-2 items-center';
          wrap.innerHTML = `<button id="btn-add-guru-admin" class="bg-emerald-600 text-white px-3 py-1 rounded text-sm">Tambah Guru</button>`;
          ph.appendChild(wrap);
          document.getElementById('btn-add-guru-admin').addEventListener('click', ()=> {
            $('#guru-modal-title').textContent='Tambah Guru'; $('#guru-nip').value=''; $('#guru-nama-input').value=''; $('#guru-jabatan-input').value=''; $('#guru-save').dataset.editId=''; $('#guru-modal').classList.remove('hidden');
          });
        }
      }
      toast('Admin terautentikasi: ' + (user.email||''), 'ok', 1600);
    } else {
      $('#btn-open-admin') && $('#btn-open-admin').classList.add('hidden');
      $('#btn-admin-logout') && $('#btn-admin-logout').classList.remove('hidden');
      toast('Signed in (bukan admin)', 'info', 1500);
    }
  });

  // Admin modal submit -> signInWithEmail (provided by app.firebase.js)
  document.addEventListener('click', async (e) => {
    if (e.target && e.target.id === 'btn-open-admin') { $('#admin-modal').classList.remove('hidden'); $('#admin-username').focus(); }
    if (e.target && e.target.id === 'admin-cancel') { $('#admin-modal').classList.add('hidden'); $('#admin-msg').textContent=''; }
    if (e.target && e.target.id === 'admin-submit') {
      const email = ($('#admin-username').value||'').trim(); const pass = ($('#admin-password').value||'').trim();
      if (!email || !pass) { $('#admin-msg').textContent = 'Masukkan email & password.'; return; }
      $('#admin-submit').disabled = true; $('#admin-msg').textContent = 'Menghubungkan...';
      try {
        if (window.signInWithEmail) {
          await window.signInWithEmail(email, pass);
          $('#admin-modal').classList.add('hidden'); $('#admin-msg').textContent=''; $('#admin-username').value=''; $('#admin-password').value='';
        } else {
          $('#admin-msg').textContent = 'Auth belum siap.';
        }
      } catch(err){
        console.error('auth err', err);
        $('#admin-msg').textContent = 'Gagal login: ' + (err && err.message ? err.message : String(err));
      } finally { $('#admin-submit').disabled = false; }
    }

    if (e.target && e.target.id === 'btn-admin-logout') {
      if (window.signOutFirebase) {
        await window.signOutFirebase();
        toast('Logout berhasil', 'ok');
      } else {
        window.dispatchEvent(new CustomEvent('auth-changed', { detail: null }));
      }
    }
  });

  // --- Guru save (create/update) ---
  $('#guru-save') && $('#guru-save').addEventListener('click', async ()=>{
    const editId = $('#guru-save').dataset.editId || '';
    const nip = ($('#guru-nip').value||'').trim(); const nama = ($('#guru-nama-input').value||'').trim(); const jab = ($('#guru-jabatan-input').value||'').trim();
    if (!nama) return toast('Masukkan nama guru','err');
    try {
      if (editId){
        if (window.updateGuruFirebase) {
          await window.updateGuruFirebase(editId, { nip, nama, jabatan: jab });
          toast('Perubahan dikirim ke server', 'ok');
        } else {
          const list = loadGuruList().map(x => x.id===editId?Object.assign({}, x, { nip, nama, jabatan: jab }):x);
          saveGuruList(list); renderGuruTable(); populateNamaSelect();
          toast('Perubahan disimpan lokal', 'ok');
        }
      } else {
        if (window.addGuruFirebase) {
          await window.addGuruFirebase({ nip, nama, jabatan: jab });
          toast('Guru ditambahkan di server', 'ok');
        } else {
          const list = loadGuruList(); const id = 'g' + Date.now();
          list.push({ id, nip, nama, jabatan: jab, status:'Aktif' }); saveGuruList(list); renderGuruTable(); populateNamaSelect();
          toast('Guru ditambahkan lokal', 'ok');
        }
      }
    } catch(err){
      console.error('guru save err', err);
      if (!editId) enqueueOp({ type:'guru_add', payload:{ nip, nama, jabatan: jab }, ts: Date.now() });
      else enqueueOp({ type:'guru_update', payload:{ id: editId, updates:{ nip, nama, jabatan: jab } }, ts: Date.now() });
      toast('Gagal simpan ke server ‚Äî antrian dibuat', 'err');
    } finally {
      $('#guru-modal').classList.add('hidden'); $('#guru-save').dataset.editId='';
    }
  });

  // --- Initial UI boot ---
  function initialBoot(){
    // populate quick UI from local caches
    renderGuruTable(); populateNamaSelect(loadGuruList()); refreshRecentActivity(); renderChart(); setPendingCount(readQueue().length);
    // try initial sync if function available
    setTimeout(async ()=> { if (window.syncFromFirebase) { try { await window.syncFromFirebase(); setLastSync(Date.now()); toast('Sinkron awal selesai', 'ok'); } catch(e){ console.warn('initial sync failed', e); } } }, 800);
  }
  initialBoot();

  // Expose control helpers for console
  window.__WH_UI = { flushQueue, enqueueOp, readQueue, renderGuruTable, populateNamaSelect, refreshRecentActivity };

})();
</script>
</body>
</html>
